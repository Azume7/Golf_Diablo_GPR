<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion Tournois Golf - Scores D√©taill√©s</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #2c5530; text-align: center; margin-bottom: 30px; }
        .nav { text-align: center; margin-bottom: 30px; }
        .nav button {
            background: #4a7c59; color: white; border: none;
            padding: 10px 20px; margin: 5px; border-radius: 5px; cursor: pointer;
        }
        .nav button:hover { background: #2c5530; }
        .nav button.active { background: #2c5530; }
        .section { display: none; }
        .section.active { display: block; }
        .btn {
            background: #4a7c59; color: white; border: none;
            padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px;
        }
        .btn:hover { background: #2c5530; }
        .btn-secondary {
            background: #6c757d; color: white; border: none;
            padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px;
        }
        .btn-danger {
            background: #dc3545; color: white; border: none;
            padding: 8px 12px; border-radius: 5px; cursor: pointer; margin: 5px;
        }
        .card {
            background: #f9f9f9; padding: 20px; margin: 15px 0;
            border-radius: 8px; border-left: 4px solid #4a7c59;
        }
        .table {
            width: 100%; border-collapse: collapse; margin: 20px 0;
        }
        .table th, .table td {
            border: 1px solid #ddd; padding: 8px; text-align: left;
        }
        .table th { background: #4a7c59; color: white; }
        .table tr:nth-child(even) { background: #f2f2f2; }
        .alert-success {
            background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
            padding: 15px; margin: 15px 0; border-radius: 5px;
        }
        .alert-danger {
            background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
            padding: 15px; margin: 15px 0; border-radius: 5px;
        }
        .form-row {
            margin: 10px 0;
        }
        .form-row label {
            display: inline-block;
            width: 150px;
            font-weight: bold;
        }
        .form-row input, .form-row select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .player-card {
            background: #fff;
            border: 2px solid #4a7c59;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .player-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c5530;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .score-history {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .score-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        .score-row:nth-child(even) {
            background: #f8f9fa;
        }
        .best-score {
            color: #28a745;
            font-weight: bold;
        }
        .worst-score {
            color: #dc3545;
            font-weight: bold;
        }
        .tournament-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .badge-diablo {
            background: #ff6b6b;
            color: white;
        }
        .badge-gpr {
            background: #4ecdc4;
            color: white;
        }
        .course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .course-card {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .course-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .course-name {
            font-weight: bold;
            color: #2c5530;
            font-size: 16px;
        }
        .tee-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #4a7c59;
        }
        .tee-color {
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
        }
        .tee-blanc { background: #666; }
        .tee-bleu { background: #007bff; }
        .tee-vert { background: #28a745; }
        .tee-jaune { background: #ffc107; color: black; }
        .tee-noir { background: #000; }
        .add-course-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #4a7c59;
            margin-top: 20px;
        }
        .tee-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 10px;
            align-items: center;
            margin: 10px 0;
        }
        .handicap-info {
            background: #e7f3ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèåÔ∏è Gestion des Tournois de Golf - Scores D√©taill√©s</h1>
        
        <div class="nav">
            <button onclick="showOverview()" class="active">Vue d'ensemble</button>
            <button onclick="showPlayerScores()">Scores par Joueur</button>
            <button onclick="showCourses()">Terrains</button>
            <button onclick="showDiablo()">Diablo</button>
            <button onclick="showGPR()">GPR</button>
            <button onclick="showProgress()">Progression</button>
            <button onclick="showDetails()">D√©tails</button>
            <button onclick="showHandicapEvolution()">üìà √âvolution Handicaps</button>
            <button onclick="showPlayerManagement()">üë• Joueurs</button>
            <button onclick="showAddRound()">‚ûï Ajouter Partie</button>
        </div>

        <!-- Section Vue d'ensemble -->
        <div id="overview" class="section active">
            <div class="card">
                <h2>üìä Statistiques G√©n√©rales</h2>
                <div id="overviewStats"></div>
            </div>
        </div>

        <!-- Section Scores par Joueur -->
        <div id="playerScores" class="section">
            <div class="card">
                <h2>üë• S√©lectionner un Joueur</h2>
                <select id="playerSelect" style="width: 300px; padding: 10px;" onchange="showPlayerDetail()">
                    <option value="">-- Choisir un joueur --</option>
                </select>
            </div>
            <div id="playerDetail"></div>
        </div>

        <!-- Section Terrains -->
        <div id="courses" class="section">
            <div class="card">
                <h2>üèåÔ∏è Gestion des Terrains</h2>
                <p>Base de donn√©es compl√®te avec ratings et slopes pour le calcul des handicaps</p>
                <div class="handicap-info">
                    <strong>‚ÑπÔ∏è Calcul des Handicaps:</strong> Les handicaps de parcours sont calcul√©s avec la formule officielle compl√®te : 
                    <em>(Handicap Index √ó Slope Rating) √∑ 113 + (Course Rating - Par)</em>. 
                    <br><strong>Antonio</strong> joue des d√©parts bleus üîµ pour certaines parties, les autres joueurs jouent toujours des d√©parts blancs ‚ö™.
                    <br>Rating = difficult√© pour un scratch, Slope = difficult√© relative, Par = nombre de coups de r√©f√©rence.
                </div>
                <button class="btn" onclick="toggleAddCourseForm()">‚ûï Ajouter un Terrain</button>
                <button class="btn-secondary" onclick="exportCourses()">üìÅ Exporter Terrains</button>
            </div>
            
            <div id="addCourseForm" class="add-course-form" style="display: none;">
                <h3>‚ûï Ajouter un Nouveau Terrain</h3>
                <div class="form-row">
                    <label>Nom du terrain:</label>
                    <input type="text" id="newCourseName" placeholder="Ex: Club de Golf Exemple" style="width: 300px;">
                </div>
                
                <h4>D√©parts disponibles:</h4>
                <div id="teeInputs">
                    <div class="tee-form-row">
                        <select>
                            <option value="blanc">Blanc</option>
                            <option value="bleu">Bleu</option>
                            <option value="vert">Vert</option>
                            <option value="jaune">Jaune</option>
                            <option value="noir">Noir</option>
                        </select>
                        <input type="number" placeholder="Rating (ex: 69.5)" step="0.1" min="60" max="80">
                        <input type="number" placeholder="Slope (ex: 123)" min="85" max="155">
                        <button type="button" class="btn-danger" onclick="removeTeeInput(this)">‚ùå</button>
                    </div>
                </div>
                
                <button class="btn-secondary" onclick="addTeeInput()">‚ûï Ajouter un D√©part</button>
                <br><br>
                <button class="btn" onclick="saveCourse()">üíæ Sauvegarder le Terrain</button>
                <button class="btn-secondary" onclick="cancelAddCourse()">‚ùå Annuler</button>
            </div>
            
            <div id="coursesList"></div>
        </div>

        <!-- Section Diablo -->
        <div id="diablo" class="section">
            <h2>üèÜ Coupe Diablo (Septembre)</h2>
            <div class="card">
                <label><strong>S√©lectionner l'ann√©e:</strong></label>
                <select id="diabloYearSelect" style="width: 150px; padding: 8px; margin: 0 10px;" onchange="loadDiablo()">
                    <option value="">-- Toutes les ann√©es --</option>
                </select>
                <span id="diabloStatus" style="margin-left: 20px; padding: 5px 10px; border-radius: 15px;"></span>
            </div>
            <div id="diabloContent"></div>
        </div>

        <!-- Section GPR -->
        <div id="gpr" class="section">
            <h2>üéØ Coupe GPR (Mai √† Juillet)</h2>
            <div class="card">
                <label><strong>S√©lectionner l'ann√©e:</strong></label>
                <select id="gprYearSelect" style="width: 150px; padding: 8px; margin: 0 10px;" onchange="loadGPR()">
                    <option value="">-- Toutes les ann√©es --</option>
                </select>
                <span id="gprStatus" style="margin-left: 20px; padding: 5px 10px; border-radius: 15px;"></span>
            </div>
            <div id="gprContent"></div>
        </div>

        <!-- Section Progression -->
        <div id="progress" class="section">
            <h2>üìà Progression des Coupes En Cours</h2>
            <div id="progressContent"></div>
        </div>

        <!-- Section D√©tails -->
        <div id="details" class="section">
            <h2>üìä D√©tails par Partie</h2>
            <div class="card">
                <select id="roundSelect" style="width: 100%; padding: 8px;" onchange="showRoundDetail()">
                    <option value="">-- S√©lectionner une partie --</option>
                </select>
            </div>
            <div id="detailsContent"></div>
        </div>
	
	<!-- Section √âvolution Handicaps -->
	<div id="handicapEvolution" class="section">
    	    <div class="card">
        	<h2>üìà √âvolution des Handicaps</h2>
        	<p>Suivez la progression des handicaps de chaque joueur au fil des parties</p>
        
        	<div style="margin: 20px 0;">
            	    <label><strong>S√©lectionner les joueurs √† comparer:</strong></label>
            	    <div id="playerCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 15px 0;"></div>
            	    <button class="btn" onclick="updateHandicapChart()">üîÑ Mettre √† jour le graphique</button>
            	    <button class="btn-secondary" onclick="selectAllPlayers()">‚úÖ Tous</button>
            	    <button class="btn-secondary" onclick="clearAllPlayers()">‚ùå Aucun</button>
            	    <button class="btn-secondary" onclick="exportHandicapData()">üìä Exporter Donn√©es</button>
        	</div>
        
        	<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
            	    <strong>L√©gende:</strong>
            	    <span style="color: #28a745;">üü¢ Am√©lioration</span> |
            	    <span style="color: #dc3545;">üî¥ D√©gradation</span> |
            	    <span style="color: #6c757d;">‚ö™ Stable</span>
        	</div>
    	    </div>
    
    	    <div id="handicapChart" class="card">
        	<canvas id="handicapCanvas" width="1000" height="500" style="max-width: 100%; border: 1px solid #ddd; border-radius: 8px;"></canvas>
    	    </div>
    
    	    <div id="handicapStats" class="card"></div>
	</div>

	<!-- Section Gestion des Joueurs -->
	<div id="playerManagement" class="section">
    	    <div class="card">
        	<h2>üë• Gestion des Joueurs</h2>
        	<p>Ajouter, modifier et g√©rer les informations des joueurs</p>
        
        	<div style="margin: 20px 0;">
            	    <button class="btn" onclick="showAddPlayerForm()">‚ûï Ajouter un Joueur</button>
            	    <button class="btn-secondary" onclick="exportPlayersData()">üìÅ Exporter Liste</button>
            	    <button class="btn-secondary" onclick="importPlayersData()">üì• Importer Liste</button>
            	    <input type="file" id="importFile" accept=".json,.csv" style="display: none;" onchange="handleFileImport(event)">
        	</div>
        
        	<div id="addPlayerForm" class="add-course-form" style="display: none;">
            	    <h3>‚ûï Ajouter un Nouveau Joueur</h3>
            	    <div class="form-row">
                	<label>Pr√©nom:</label>
                	<input type="text" id="newPlayerFirstName" placeholder="Ex: Jean" style="width: 200px;">
            	    </div>
            	    <div class="form-row">
                	<label>Nom:</label>
                	<input type="text" id="newPlayerLastName" placeholder="Ex: Dupont" style="width: 200px;">
            	    </div>
            	    <div class="form-row">
                	<label>T√©l√©phone:</label>
                	<input type="tel" id="newPlayerPhone" placeholder="Ex: 514-555-1234" style="width: 200px;">
            	    </div>
            	    <div class="form-row">
                	<label>Courriel:</label>
                	<input type="email" id="newPlayerEmail" placeholder="Ex: jean.dupont@example.com" style="width: 300px;">
            	    </div>
            	    <div class="form-row">
                	<label>Handicap Initial:</label>
                	<input type="number" id="newPlayerHandicap" placeholder="Ex: 15.5" step="0.1" min="0" max="36.4" style="width: 100px;">
            	    </div>
            	    <div class="form-row">
                	<label>Date d'adh√©sion:</label>
                	<input type="date" id="newPlayerDateJoined" style="width: 200px;">
            	    </div>
            	    <br>
            	    <button class="btn" onclick="saveNewPlayer()">üíæ Sauvegarder</button>
            	    <button class="btn-secondary" onclick="cancelAddPlayer()">‚ùå Annuler</button>
        	</div>
    	    </div>
    
    	    <div id="playersGrid" class="course-grid"></div>
	</div>

	<!-- Section Ajouter une Partie -->
	<div id="addRound" class="section">
    	    <div class="card">
        	<h2>‚ûï Ajouter une Nouvelle Partie</h2>
        	<p>Enregistrer les scores d'une nouvelle partie de golf</p>
        
        	<!-- Informations de base de la partie -->
        	<div class="card" style="background: #f8f9fa;">
            	    <h3>üìÖ Informations de la Partie</h3>
            
            	    <div class="form-row">
                	<label>Date de la partie:</label>
                	<input type="date" id="newRoundDate" style="width: 200px;">
            	    </div>
            
            	    <div class="form-row">
                	<label>Terrain:</label>
                	<select id="newRoundCourse" style="width: 300px;" onchange="updateAvailableTees()">
                    	    <option value="">-- S√©lectionner un terrain --</option>
                	</select>
            	    </div>
            
            	    <div class="form-row">
                	<label>D√©part par d√©faut:</label>
                	<select id="newRoundDefaultTee" style="width: 150px;">
                    	    <option value="">-- Choisir --</option>
                	</select>
                	<small style="margin-left: 10px; color: #666;">Les joueurs peuvent avoir des d√©parts individuels</small>
            	    </div>
            
            	    <div class="form-row">
                	<label>Type de partie:</label>
                	<select id="newRoundType" style="width: 200px;">
                    	    <option value="gpr">üéØ GPR (Mai-Juillet)</option>
                    	    <option value="diablo">üèÜ Diablo (Septembre)</option>
                    	    <option value="amicale">‚õ≥ Partie Amicale</option>
                	</select>
            	    </div>
        	</div>
        
        	<!-- S√©lection des joueurs et scores -->
        	<div class="card">
            	    <h3>üë• Joueurs et Scores</h3>
            	    <p>S√©lectionnez les joueurs pr√©sents et saisissez leurs scores</p>
            
            	    <div style="margin: 15px 0;">
                	<button class="btn-secondary" onclick="selectAllPlayersForRound()">‚úÖ Tous les joueurs</button>
                	<button class="btn-secondary" onclick="clearAllPlayersForRound()">‚ùå Aucun joueur</button>
                	<button class="btn-secondary" onclick="selectFrequentPlayers()">‚≠ê Joueurs fr√©quents</button>
            	    </div>
            
            	    <div id="playersScoreGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 15px; margin-top: 20px;"></div>
        	</div>
        
        	<!-- Boutons d'action -->
        	<div class="card" style="text-align: center;">
            	    <button class="btn" onclick="saveNewRound()">üíæ Enregistrer la Partie</button>
            	    <button class="btn-secondary" onclick="previewNewRound()">üëÅÔ∏è Aper√ßu</button>
            	    <button class="btn-secondary" onclick="resetNewRoundForm()">üîÑ R√©initialiser</button>
        	</div>
        
        	<!-- Aper√ßu de la partie -->
        	<div id="newRoundPreview" class="card" style="display: none;">
            	    <h3>üëÅÔ∏è Aper√ßu de la Partie</h3>
            	    <div id="previewContent"></div>
        	</div>
    	    </div>
	</div>
    </div>

    <!-- LE JAVASCRIPT SERA DANS LES AUTRES PARTIES -->
    <script>
        console.log('üî• PARTIE 1 CHARG√âE - HTML + CSS pr√™ts!');
    </script>
</body>
</html>

// ==============================================================================
// PARTIE 2: JAVASCRIPT CORE + FIREBASE INTEGRATION
// ==============================================================================

// Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyCHh6Fb-m18O-_1Ei6sTEdfnJMyNrSl590",
    authDomain: "golf-scores-app-bba13.firebaseapp.com",
    databaseURL: "https://golf-scores-app-bba13-default-rtdb.firebaseio.com",
    projectId: "golf-scores-app-bba13",
    storageBucket: "golf-scores-app-bba13.firebasestorage.app",
    messagingSenderId: "170312505084",
    appId: "1:170312505084:web:074ae5e6d9d74c70efa979"
};

// Initialiser Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

console.log('üî• Firebase initialis√© avec succ√®s!');

// ==============================================================================
// VARIABLES GLOBALES
// ==============================================================================

// Base de donn√©es des terrains avec ratings, slopes et pars
var coursesDatabase = {
    "Parcours de l'√Æle": [
        {tee: "blanc", rating: 68.6, slope: 122, par: 70},
        {tee: "bleu", rating: 70.9, slope: 127, par: 70}
    ],
    "Parcours de l'Irlande": [
        {tee: "blanc", rating: 69.4, slope: 126, par: 71},
        {tee: "bleu", rating: 72.2, slope: 131, par: 71}
    ],
    "Parcours Atlantide": [
        {tee: "blanc", rating: 68.6, slope: 126, par: 72},
        {tee: "bleu", rating: 70.2, slope: 132, par: 72}
    ],
    "Parcours Don Quichotte": [
        {tee: "blanc", rating: 65.9, slope: 113, par: 71},
        {tee: "bleu", rating: 68.4, slope: 117, par: 71}
    ],
    "Triangle D'Or": [
        {tee: "blanc", rating: 69.8, slope: 123, par: 72},
        {tee: "bleu", rating: 70.8, slope: 127, par: 72}
    ],
    "Hemmingford Parcours Fronti√®re": [
        {tee: "blanc", rating: 70.3, slope: 123, par: 71},
        {tee: "bleu", rating: 71.1, slope: 125, par: 71}
    ],
    "Vall√©e des Forts": [
        {tee: "blanc", rating: 70.2, slope: 127, par: 72},
        {tee: "bleu", rating: 71.9, slope: 135, par: 72}
    ],
    "St-Zotique": [
        {tee: "blanc", rating: 68, slope: 114, par: 72},
        {tee: "bleu", rating: 70.1, slope: 118, par: 72}
    ],
    "Parcours Le Pr√©sidentiel": [
        {tee: "blanc", rating: 69.7, slope: 118, par: 72},
        {tee: "bleu", rating: 71.5, slope: 123, par: 72}
    ],
    "Parcours Le Doral": [
        {tee: "blanc", rating: 70, slope: 124, par: 72},
        {tee: "bleu", rating: 71.7, slope: 128, par: 72}
    ],
    "Parcours Woodlands": [
        {tee: "blanc", rating: 68.7, slope: 116, par: 72},
        {tee: "bleu", rating: 70.1, slope: 119, par: 72}
    ],
    "Parcours Bellevue": [
        {tee: "blanc", rating: 69, slope: 115, par: 72},
        {tee: "bleu", rating: 70.3, slope: 118, par: 72}
    ],
    "Rivi√®re-Rouge": [
        {tee: "blanc", rating: 68.8, slope: 123, par: 71},
        {tee: "bleu", rating: 70.5, slope: 124, par: 71}
    ],
    "Les L√©gendes": [
        {tee: "blanc", rating: 70.8, slope: 118, par: 72},
        {tee: "bleu", rating: 72.3, slope: 126, par: 72}
    ],
    "La Seigneurie": [
        {tee: "blanc", rating: 68.5, slope: 123, par: 70},
        {tee: "bleu", rating: 69.5, slope: 126, par: 70}
    ],
    "Napierville": [
        {tee: "blanc", rating: 68.2, slope: 125, par: 72},
        {tee: "bleu", rating: 70.7, slope: 129, par: 72}
    ],
    "St-Polycarpe": [
        {tee: "blanc", rating: 66.8, slope: 118, par: 72},
        {tee: "bleu", rating: 71, slope: 125, par: 72}
    ],
    "Rive-Sud": [
        {tee: "blanc", rating: 71.2, slope: 124, par: 72},
        {tee: "bleu", rating: 72.4, slope: 127, par: 72}
    ],
    "Rivi√®re-Beaudette": [
        {tee: "blanc", rating: 69.2, slope: 117, par: 72},
        {tee: "bleu", rating: 70.6, slope: 120, par: 72}
    ],
    "Vaudreuil": [
        {tee: "blanc", rating: 66.5, slope: 108, par: 70},
        {tee: "bleu", rating: 68.2, slope: 112, par: 70}
    ],
    "Brocart": [
        {tee: "blanc", rating: 68, slope: 115, par: 72},
        {tee: "vert", rating: 69.4, slope: 118, par: 72},
        {tee: "jaune", rating: 69.4, slope: 118, par: 72}
    ],
    "Faon": [
        {tee: "vert", rating: 70.7, slope: 122, par: 71},
        {tee: "jaune", rating: 69.2, slope: 123, par: 71}
    ],
    "Beloeil": [
        {tee: "blanc", rating: 67.2, slope: 123, par: 71},
        {tee: "bleu", rating: 70, slope: 132, par: 71}
    ],
    "Golfdes√éles": [
        {tee: "blanc", rating: 66.5, slope: 110, par: 70},
        {tee: "bleu", rating: 68.5, slope: 115, par: 70}
    ],
    "St-C√©saire": [
        {tee: "blanc", rating: 70, slope: 122, par: 72},
        {tee: "bleu", rating: 70, slope: 122, par: 72}
    ],
    "Golf Cowansville": [
        {tee: "blanc", rating: 69.6, slope: 118, par: 72},
        {tee: "bleu", rating: 71, slope: 123, par: 72}
    ],
    "Ch√¢teau Bromont": [
        {tee: "blanc", rating: 69.3, slope: 123, par: 72},
        {tee: "bleu", rating: 69.8, slope: 116, par: 72}
    ],
    "Golf Coaticook": [
        {tee: "blanc", rating: 66.4, slope: 114, par: 71},
        {tee: "bleu", rating: 68, slope: 119, par: 71}
    ],
    "Golf Farnham": [
        {tee: "blanc", rating: 67.8, slope: 121, par: 71},
        {tee: "bleu", rating: 69.4, slope: 124, par: 71}
    ],
    "Milby": [
        {tee: "blanc", rating: 69.5, slope: 123, par: 73},
        {tee: "bleu", rating: 71.1, slope: 131, par: 73}
    ],
    "Manoir des Sables": [
        {tee: "blanc", rating: 69, slope: 118, par: 71},
        {tee: "bleu", rating: 69, slope: 123, par: 71}
    ],
    "Mont Orford": [
        {tee: "blanc", rating: 69, slope: 118, par: 72},
        {tee: "bleu", rating: 69, slope: 126, par: 72}
    ],
    "Royal Bromont": [
        {tee: "blanc", rating: 67, slope: 114, par: 72},
        {tee: "bleu", rating: 69.3, slope: 120, par: 72}
    ],
    "Parcours du Vieux Village": [
        {tee: "blanc", rating: 68.2, slope: 114, par: 72},
        {tee: "bleu", rating: 70.3, slope: 124, par: 72}
    ],
    "Royal Laurentien": [
        {tee: "blanc", rating: 66.2, slope: 115, par: 71},
        {tee: "bleu", rating: 68.6, slope: 121, par: 71}
    ],
    "Le Diable": [
        {tee: "blanc", rating: 69.9, slope: 126, par: 70},
        {tee: "bleu", rating: 72, slope: 131, par: 70}
    ],
    "Le G√©ant": [
        {tee: "vert", rating: 68, slope: 123, par: 72},
        {tee: "noir", rating: 70.4, slope: 125, par: 72}
    ],
    "Arundel": [
        {tee: "blanc", rating: 69.7, slope: 126, par: 72},
        {tee: "bleu", rating: 70.7, slope: 128, par: 72}
    ],
    "La Belle": [
        {tee: "blanc", rating: 68, slope: 121, par: 73},
        {tee: "bleu", rating: 69, slope: 124, par: 73}
    ],
    "Le Ma√Ætre": [
        {tee: "blanc", rating: 68.7, slope: 121, par: 72},
        {tee: "bleu", rating: 70.2, slope: 125, par: 72}
    ],
    "La B√™te": [
        {tee: "blanc", rating: 68.7, slope: 124, par: 72},
        {tee: "bleu", rating: 71.4, slope: 128, par: 72}
    ],
    "Lorraine": [
        {tee: "blanc", rating: 69.5, slope: 123, par: 72},
        {tee: "bleu", rating: 70.4, slope: 124, par: 72}
    ],
    "St-Jean limit√©": [
        {tee: "blanc", rating: 69.3, slope: 120, par: 72},
        {tee: "bleu", rating: 71.4, slope: 123, par: 72}
    ]
};

// Joueurs avec propri√©t√© 'name'
var players = [
    {id: 1, name: 'Antonio Coccaro', firstName: 'Antonio', lastName: 'Coccaro', phone: '514-555-0101', email: 'antonio.coccaro@example.com', handicap: 9.8, dateJoined: '2023-05-01', active: true},
    {id: 2, name: 'Patrick Gu√®vremont', firstName: 'Patrick', lastName: 'Gu√®vremont', phone: '514-555-0102', email: 'patrick.guevremont@example.com', handicap: 17.7, dateJoined: '2023-05-01', active: true},
    {id: 3, name: 'Patrice Archetto', firstName: 'Patrice', lastName: 'Archetto', phone: '514-555-0103', email: 'patrice.archetto@example.com', handicap: 17.0, dateJoined: '2023-05-01', active: true},
    {id: 4, name: 'Patrick Goessens', firstName: 'Patrick', lastName: 'Goessens', phone: '514-555-0104', email: 'patrick.goessens@example.com', handicap: 18.7, dateJoined: '2023-05-01', active: true},
    {id: 5, name: 'Jochen Pr√©vost', firstName: 'Jochen', lastName: 'Pr√©vost', phone: '514-555-0105', email: 'jochen.prevost@example.com', handicap: 25.3, dateJoined: '2023-05-01', active: true},
    {id: 6, name: 'Bruno Chaput', firstName: 'Bruno', lastName: 'Chaput', phone: '514-555-0106', email: 'bruno.chaput@example.com', handicap: 36.7, dateJoined: '2023-05-01', active: true},
    {id: 7, name: 'F√©lix Charland', firstName: 'F√©lix', lastName: 'Charland', phone: '514-555-0107', email: 'felix.charland@example.com', handicap: 18.5, dateJoined: '2023-05-01', active: true},
    {id: 8, name: 'S√©bastien Pronovost', firstName: 'S√©bastien', lastName: 'Pronovost', phone: '514-555-0108', email: 'sebastien.pronovost@example.com', handicap: 22.2, dateJoined: '2023-05-01', active: true},
    {id: 9, name: '√âric Desjardins', firstName: '√âric', lastName: 'Desjardins', phone: '514-555-0109', email: 'eric.desjardins@example.com', handicap: 20.5, dateJoined: '2023-05-01', active: true},
    {id: 10, name: 'Martial Pag√©', firstName: 'Martial', lastName: 'Pag√©', phone: '514-555-0110', email: 'martial.page@example.com', handicap: 26.8, dateJoined: '2023-05-01', active: true},
    {id: 11, name: 'Patrick Rochon', firstName: 'Patrick', lastName: 'Rochon', phone: '514-555-0111', email: 'patrick.rochon@example.com', handicap: 26.3, dateJoined: '2023-05-01', active: true},
    {id: 12, name: 'Richard Wahba', firstName: 'Richard', lastName: 'Wahba', phone: '514-555-0112', email: 'richard.wahba@example.com', handicap: 23.3, dateJoined: '2023-05-01', active: true},
    {id: 13, name: '√âric Gosselin', firstName: '√âric', lastName: 'Gosselin', phone: '514-555-0113', email: 'eric.gosselin@example.com', handicap: 14.9, dateJoined: '2024-09-01', active: true}
];

// Donn√©es des parties
var dates = [
    '2023-06-03', '2023-06-10', '2023-07-01', '2023-07-02', '2023-09-01', '2023-09-02', '2023-09-03',
    '2024-05-04', '2024-05-18', '2024-05-25', '2024-06-08', '2024-06-15', '2024-06-29', '2024-06-30',
    '2024-09-06', '2024-09-07', '2024-09-08', '2025-05-03', '2025-05-17', '2025-06-07', '2025-06-14', '2025-06-21'
];

var courses = [
    'Rivi√®re-Rouge', 'Hemmingford Parcours Fronti√®re', 'Parcours Don Quichotte', 'Parcours Don Quichotte',
    'Le Diable', 'Le G√©ant', 'Le G√©ant', 'Vaudreuil', 'Hemmingford Parcours Fronti√®re', 'Vall√©e des Forts',
    'Parcours Bellevue', 'Rivi√®re-Rouge', 'Parcours Don Quichotte', 'Parcours Don Quichotte',
    'Manoir des Sables', 'Manoir des Sables', 'Manoir des Sables', 'Vaudreuil', 'Hemmingford Parcours Fronti√®re',
    'Lorraine', 'Parcours Bellevue', 'St-Jean limit√©'
];

// D√©parts utilis√©s pour chaque partie
var teeUsed = [
    'blanc', 'blanc', 'blanc', 'bleu', 'blanc', 'blanc', 'blanc', 'bleu', 'bleu', 'bleu', 'bleu', 'bleu', 'bleu', 'bleu',
    'blanc', 'blanc', 'bleu', 'bleu', 'bleu', 'bleu', 'blanc', 'bleu'
];

// Scores r√©els pour chaque joueur
var allScores = [
    [83, 83, 78, 80, 79, 84, 85, 85, 81, 83, 80, 89, 80, 83, 91, 88, 92, 84, 88, 85, null, 97], // Antonio
    [89, 91, 91, 89, 93, 101, 95, 89, 98, 84, 93, 92, 83, 86, 107, 102, 111, 96, 97, 90, 91, 97], // Patrick G
    [88, 103, 88, 84, 96, 88, 89, 97, 87, null, null, 94, 94, 85, 93, 95, 95, null, null, null, 109, 96], // Patrice
    [86, 93, 80, 87, 93, 100, 109, 103, 97, null, 99, 97, 90, 90, 94, 93, 88, 94, 94, 102, 99, 101], // Patrick G
    [104, 110, 101, 80, 106, 106, 105, 102, null, 95, 104, null, 88, 93, 110, 109, 105, 98, 108, 113, 107, 99], // Jochen
    [111, 120, 118, 121, null, 113, 106, 126, 124, 115, null, null, null, null, 127, 116, 126, null, 122, 109, null, 115], // Bruno
    [100, 98, 89, 99, 101, 102, 97, 97, 104, 84, 94, 94, 84, 87, 92, 91, 97, 91, 90, null, 98, 89], // F√©lix
    [97, 101, 103, 88, 106, 101, 106, 103, 103, 104, null, 99, 97, 86, 102, 94, 119, null, 96, null, 110, 103], // S√©bastien
    [99, 98, 90, 86, 95, 92, 99, 103, 103, 89, 105, 98, 92, 90, 91, 90, 100, 98, 99, 102, null, 100], // √âric D
    [112, 116, 105, 91, 105, 97, 99, 98, null, 101, 109, 99, 93, 102, 102, 107, 102, 106, 106, 109, 99, 110], // Martial
    [109, 111, 97, 95, 98, 110, 96, 99, 111, null, 115, 105, 92, 100, 106, 115, 107, 100, null, null, null, null], // Patrick R
    [101, 101, 96, 95, null, null, null, 95, 105, 95, 95, null, 88, 97, null, null, 102, 97, 108, 95, 114, 105], // Richard
    [null, null, null, null, null, null, null, null, null, null, null, null, null, 117, 119, null, null, null, null, null, null, null] // √âric G
];

// Variables globales
var rounds = [];
var scores = [];
var handicapCache = {};
var handicapEvolutionData = {};
var selectedPlayers = [];
var newRoundPlayers = {};

// ==============================================================================
// FONCTIONS DE CALCUL DES HANDICAPS
// ==============================================================================

// Fonction pour calculer le handicap de parcours avec la formule compl√®te
function calculateCourseHandicap(playerHandicapIndex, courseName, teeColor) {
    if (!coursesDatabase[courseName]) {
        console.warn('Terrain non trouv√©:', courseName);
        return playerHandicapIndex;
    }
    
    var courseData = coursesDatabase[courseName];
    var teeData = courseData.find(t => t.tee === teeColor);
    
    if (!teeData) {
        teeData = courseData[0];
        console.warn('D√©part', teeColor, 'non trouv√© pour', courseName, ', utilisation de', teeData.tee);
    }
    
    // Formule compl√®te: (Handicap Index √ó Slope Rating) √∑ 113 + (Course Rating - Par)
    var slopeAdjustment = (playerHandicapIndex * teeData.slope) / 113;
    var ratingAdjustment = teeData.rating - teeData.par;
    var courseHandicap = slopeAdjustment + ratingAdjustment;
    
    return Math.round(courseHandicap * 10) / 10;
}

// Fonction pour calculer le diff√©rentiel de score
function calculateScoreDifferentialReal(grossScore, courseName, teeColor) {
    if (!coursesDatabase[courseName]) {
        console.warn('Terrain non trouv√©:', courseName);
        return null;
    }

    var courseData = coursesDatabase[courseName];
    var teeData = courseData.find(t => t.tee === teeColor);

    if (!teeData) {
        teeData = courseData[0];
        console.warn('D√©part', teeColor, 'non trouv√© pour', courseName, ', utilisation de', teeData.tee);
    }

    // Score Differential = (Gross Score - Course Rating) √ó 113 / Slope Rating
    var differential = (grossScore - teeData.rating) * 113 / teeData.slope;
    return Math.round(differential * 10) / 10;
}

// Calculer le nouveau handicap bas√© sur les diff√©rentiels
function calculateNewHandicapFromDifferentials(differentials, initialHandicap) {
    if (differentials.length < 5) {
        return initialHandicap;
    }

    var sortedDifferentials = [...differentials].sort((a, b) => a - b);

    var scoresToUse = 1;
    if (differentials.length >= 20) {
        scoresToUse = 8;
    } else if (differentials.length >= 15) {
        scoresToUse = 5;
    } else if (differentials.length >= 10) {
        scoresToUse = 3;
    } else if (differentials.length >= 7) {
        scoresToUse = 2;
    }

    var bestDifferentials = sortedDifferentials.slice(0, scoresToUse);
    var average = bestDifferentials.reduce((sum, d) => sum + d, 0) / scoresToUse;
    var newHandicap = average * 0.96;

    newHandicap = Math.max(0, Math.min(36.4, newHandicap));
    return Math.round(newHandicap * 10) / 10;
}

// ==============================================================================
// FONCTIONS FIREBASE - SAUVEGARDE ET CHARGEMENT
// ==============================================================================

// Sauvegarder toutes les donn√©es dans Firebase
function saveToFirebase() {
    console.log('üíæ Sauvegarde dans Firebase...');
    
    const dataToSave = {
        players: players,
        coursesDatabase: coursesDatabase,
        dates: dates,
        courses: courses,
        teeUsed: teeUsed,
        allScores: allScores,
        lastUpdated: firebase.database.ServerValue.TIMESTAMP
    };

    return database.ref('golfData').set(dataToSave)
        .then(() => {
            console.log('‚úÖ Donn√©es sauvegard√©es avec succ√®s dans Firebase!');
            showFirebaseStatus('Donn√©es sauvegard√©es avec succ√®s! ‚úÖ', 'success');
        })
        .catch((error) => {
            console.error('‚ùå Erreur lors de la sauvegarde:', error);
            showFirebaseStatus('Erreur lors de la sauvegarde: ' + error.message, 'error');
        });
}

// Charger les donn√©es depuis Firebase
function loadFromFirebase() {
    console.log('üì• Chargement depuis Firebase...');
    
    return database.ref('golfData').once('value')
        .then((snapshot) => {
            const data = snapshot.val();
            
            if (data) {
                // Restaurer les donn√©es
                if (data.players) players = data.players;
                if (data.coursesDatabase) coursesDatabase = data.coursesDatabase;
                if (data.dates) dates = data.dates;
                if (data.courses) courses = data.courses;
                if (data.teeUsed) teeUsed = data.teeUsed;
                if (data.allScores) allScores = data.allScores;
                
                console.log('‚úÖ Donn√©es charg√©es depuis Firebase!');
                console.log('- Joueurs:', players.length);
                console.log('- Terrains:', Object.keys(coursesDatabase).length);
                console.log('- Parties:', dates.length);
                
                // R√©initialiser l'interface
                fixAllPlayerNames();
                initializeData();
                loadOverview();
                
                showFirebaseStatus('Donn√©es charg√©es avec succ√®s! ‚úÖ', 'success');
                
                return true;
            } else {
                console.log('‚ÑπÔ∏è Aucune donn√©e trouv√©e dans Firebase, utilisation des donn√©es par d√©faut');
                showFirebaseStatus('Aucune donn√©e dans Firebase, utilisation des donn√©es par d√©faut', 'info');
                return false;
            }
        })
        .catch((error) => {
            console.error('‚ùå Erreur lors du chargement:', error);
            showFirebaseStatus('Erreur lors du chargement: ' + error.message, 'error');
            return false;
        });
}

// Afficher le statut Firebase
function showFirebaseStatus(message, type) {
    // Cr√©er ou mettre √† jour le message de statut
    var statusDiv = document.getElementById('firebaseStatus');
    if (!statusDiv) {
        statusDiv = document.createElement('div');
        statusDiv.id = 'firebaseStatus';
        statusDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 1000;
            font-weight: bold;
            max-width: 300px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        `;
        document.body.appendChild(statusDiv);
    }
    
    // D√©finir les couleurs selon le type
    var colors = {
        success: { bg: '#d4edda', text: '#155724', border: '#c3e6cb' },
        error: { bg: '#f8d7da', text: '#721c24', border: '#f5c6cb' },
        info: { bg: '#d1ecf1', text: '#0c5460', border: '#bee5eb' }
    };
    
    var color = colors[type] || colors.info;
    statusDiv.style.backgroundColor = color.bg;
    statusDiv.style.color = color.text;
    statusDiv.style.border = `1px solid ${color.border}`;
    statusDiv.textContent = message;
    
    // Masquer apr√®s 5 secondes
    setTimeout(() => {
        if (statusDiv && statusDiv.parentNode) {
            statusDiv.parentNode.removeChild(statusDiv);
        }
    }, 5000);
}

// Synchroniser automatiquement les modifications importantes
function autoSave() {
    // Sauvegarder automatiquement apr√®s certaines actions
    setTimeout(() => {
        saveToFirebase();
    }, 1000); // D√©lai de 1 seconde pour √©viter les sauvegardes trop fr√©quentes
}

// ==============================================================================
// INITIALISATION DES DONN√âES
// ==============================================================================

function initializeData() {
    rounds = [];
    scores = [];
    handicapCache = {};

    for (var i = 0; i < dates.length; i++) {
        var courseName = courses[i];
        var isDiablo = (courseName === 'Le Diable' || courseName === 'Le G√©ant' || courseName === 'Manoir des Sables');
        var gameDate = new Date(dates[i]);
        var year = gameDate.getFullYear();
        var month = gameDate.getMonth() + 1;
        
        rounds.push({
            id: i + 1,
            date: dates[i],
            course: courseName,
            tee: teeUsed[i],
            type: isDiablo ? 'diablo' : 'gpr',
            year: year,
            month: month
        });

        // Ajouter les scores avec calcul dynamique du handicap
        for (var j = 0; j < players.length; j++) {
            var grossScore = allScores[j][i];
            
            if (grossScore !== null) {
                var player = players[j];
                var teeForPlayer = teeUsed[i];
                
                // Antonio (id=1) joue des bleus pour certaines parties, les autres jouent des blancs
                if (player.id !== 1) {
                    teeForPlayer = 'blanc';
                }
                
                var courseHandicap = calculateCourseHandicap(player.handicap, courseName, teeForPlayer);
                var netScore = grossScore - courseHandicap;
                
                scores.push({
                    roundId: i + 1,
                    playerId: player.id,
                    playerName: player.name,
                    score: grossScore,
                    courseHandicap: courseHandicap,
                    net: netScore,
                    tee: teeForPlayer,
                    type: isDiablo ? 'diablo' : 'gpr',
                    year: year,
                    month: month
                });
            }
        }
    }
}

// ==============================================================================
// FONCTIONS DE NAVIGATION
// ==============================================================================

function showOverview() {
    hideAllSections();
    document.getElementById('overview').style.display = 'block';
    setActiveButton(0);
    loadOverview();
}

function showPlayerScores() {
    hideAllSections();
    document.getElementById('playerScores').style.display = 'block';
    setActiveButton(1);
    loadPlayerSelector();
}

function showCourses() {
    hideAllSections();
    document.getElementById('courses').style.display = 'block';
    setActiveButton(2);
    loadCoursesList();
}

function showDiablo() {
    hideAllSections();
    document.getElementById('diablo').style.display = 'block';
    setActiveButton(3);
    loadDiablo();
}

function showGPR() {
    hideAllSections();
    document.getElementById('gpr').style.display = 'block';
    setActiveButton(4);
    loadGPR();
}

function showProgress() {
    hideAllSections();
    document.getElementById('progress').style.display = 'block';
    setActiveButton(5);
    loadProgress();
}

function showDetails() {
    hideAllSections();
    document.getElementById('details').style.display = 'block';
    setActiveButton(6);
    loadDetails();
}

function showHandicapEvolution() {
    hideAllSections();
    document.getElementById('handicapEvolution').style.display = 'block';
    setActiveButton(7);
    loadHandicapEvolution();
}

function showPlayerManagement() {
    hideAllSections();
    document.getElementById('playerManagement').style.display = 'block';
    setActiveButton(8);
    loadPlayersGrid();
}

function showAddRound() {
    hideAllSections();
    document.getElementById('addRound').style.display = 'block';
    setActiveButton(9);
    loadAddRoundInterface();
}

function hideAllSections() {
    var sections = ['overview', 'playerScores', 'courses', 'diablo', 'gpr', 'progress', 'details', 'handicapEvolution', 'playerManagement', 'addRound'];
    for (var i = 0; i < sections.length; i++) {
        document.getElementById(sections[i]).style.display = 'none';
    }
}

function setActiveButton(index) {
    var buttons = document.querySelectorAll('.nav button');
    for (var i = 0; i < buttons.length; i++) {
        if (i === index) {
            buttons[i].classList.add('active');
        } else {
            buttons[i].classList.remove('active');
        }
    }
}

// ==============================================================================
// SECTION VUE D'ENSEMBLE
// ==============================================================================

function loadOverview() {
    var totalGames = rounds.length;
    var totalScores = scores.length;
    var activePlayers = getUniquePlayersCount(scores);
    var totalCourses = Object.keys(coursesDatabase).length;

    var diabloGames = rounds.filter(r => r.type === 'diablo').length;
    var gprGames = rounds.filter(r => r.type === 'gpr').length;

    var html = '<div class="player-stats">' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + totalGames + '</div>' +
               '<div class="stat-label">Parties Total</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + activePlayers + '</div>' +
               '<div class="stat-label">Joueurs Actifs</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + totalCourses + '</div>' +
               '<div class="stat-label">Terrains en Base</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + diabloGames + '</div>' +
               '<div class="stat-label">Parties Diablo</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + gprGames + '</div>' +
               '<div class="stat-label">Parties GPR</div>' +
               '</div>' +
               '</div>';

    // Top performers
    var allPlayerStats = [];
    for (var i = 0; i < players.length; i++) {
        var player = players[i];
        var playerScores = scores.filter(s => s.playerId === player.id);
        if (playerScores.length > 0) {
            var avgGross = playerScores.reduce((sum, s) => sum + s.score, 0) / playerScores.length;
            var avgNet = playerScores.reduce((sum, s) => sum + s.net, 0) / playerScores.length;
            var bestGross = Math.min(...playerScores.map(s => s.score));
            var bestNet = Math.min(...playerScores.map(s => s.net));
            
            allPlayerStats.push({
                player: player,
                playerName: player.name || (player.firstName + ' ' + player.lastName),
                games: playerScores.length,
                avgGross: avgGross,
                avgNet: avgNet,
                bestGross: bestGross,
                bestNet: bestNet
            });
        }
    }

    allPlayerStats.sort((a, b) => a.avgNet - b.avgNet);

    html += '<h3>üèÜ Top 5 Joueurs (Score Net Moyen)</h3>' +
            '<table class="table">' +
            '<thead><tr><th>Rang</th><th>Joueur</th><th>Parties</th><th>Moy. Brut</th><th>Moy. Net</th><th>Meilleur Net</th></tr></thead>' +
            '<tbody>';

    for (var i = 0; i < Math.min(5, allPlayerStats.length); i++) {
        var stat = allPlayerStats[i];
        var rowStyle = '';
        if (i === 0) rowStyle = ' style="background: gold;"';
        else if (i === 1) rowStyle = ' style="background: silver;"';
        else if (i === 2) rowStyle = ' style="background: #cd7f32;"';
        
        html += '<tr' + rowStyle + '>' +
                '<td><strong>' + (i + 1) + '</strong></td>' +
                '<td><strong>' + stat.playerName + '</strong></td>' +
                '<td>' + stat.games + '</td>' +
                '<td>' + stat.avgGross.toFixed(1) + '</td>' +
                '<td><strong>' + stat.avgNet.toFixed(1) + '</strong></td>' +
                '<td>' + stat.bestNet.toFixed(1) + '</td>' +
                '</tr>';
    }

    html += '</tbody></table>';

    // Boutons Firebase
    html += '<div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">' +
            '<h4 style="color: #007bff; margin-top: 0;">üî• Synchronisation Firebase</h4>' +
            '<p>Sauvegardez et synchronisez vos donn√©es dans le cloud</p>' +
            '<button class="btn" onclick="saveToFirebase()" style="background: #007bff;">üíæ Sauvegarder dans Firebase</button>' +
            '<button class="btn-secondary" onclick="loadFromFirebase()">üì• Charger depuis Firebase</button>' +
            '<button class="btn-secondary" onclick="exportBackup()">üìÅ Exporter Backup Local</button>' +
            '</div>';

    document.getElementById('overviewStats').innerHTML = html;
}

// Fonction pour exporter un backup local
function exportBackup() {
    var backupData = {
        players: players,
        coursesDatabase: coursesDatabase,
        dates: dates,
        courses: courses,
        teeUsed: teeUsed,
        allScores: allScores,
        exportDate: new Date().toISOString(),
        version: "1.0"
    };
    
    var dataStr = JSON.stringify(backupData, null, 2);
    var dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    var link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'golf-backup-' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
    
    showFirebaseStatus('Backup local export√© avec succ√®s! üìÅ', 'success');
}

// ==============================================================================
// FONCTIONS UTILITAIRES
// ==============================================================================

function getUniquePlayersCount(scoresList) {
    var playerIds = [];
    for (var i = 0; i < scoresList.length; i++) {
        if (playerIds.indexOf(scoresList[i].playerId) === -1) {
            playerIds.push(scoresList[i].playerId);
        }
    }
    return playerIds.length;
}

function fixAllPlayerNames() {
    console.log("R√©paration des noms de joueurs...");
    
    for (var i = 0; i < players.length; i++) {
        var player = players[i];
        
        if (!player.name && player.firstName && player.lastName) {
            player.name = player.firstName + ' ' + player.lastName;
            console.log("R√©par√©:", player.name);
        }
        else if (player.name && (!player.firstName || !player.lastName)) {
            var parts = player.name.split(' ');
            player.firstName = parts[0] || '';
            player.lastName = parts.slice(1).join(' ') || '';
            console.log("Ajout√© firstName/lastName pour:", player.name);
        }
    }

    // Mettre √† jour tous les scores existants avec les bons noms
    for (var i = 0; i < scores.length; i++) {
        var score = scores[i];
        var player = players.find(p => p.id === score.playerId);
        if (player && (!score.playerName || score.playerName === 'undefined')) {
            score.playerName = getPlayerDisplayName(player);
        }
    }
    
    console.log("R√©paration termin√©e!");
}

function getPlayerDisplayName(player) {
    if (player.name) {
        return player.name;
    } else if (player.firstName && player.lastName) {
        return player.firstName + ' ' + player.lastName;
    } else if (player.firstName) {
        return player.firstName;
    } else {
        return 'Joueur #' + player.id;
    }
}

// ==============================================================================
// PARTIE 3: FONCTIONNALIT√âS AVANC√âES - TERRAINS, JOUEURS, DIABLO, GPR, ETC.
// ==============================================================================

// ==============================================================================
// SECTION SCORES PAR JOUEUR
// ==============================================================================

function loadPlayerSelector() {
    var select = document.getElementById('playerSelect');
    select.innerHTML = '<option value="">-- Choisir un joueur --</option>';

    for (var i = 0; i < players.length; i++) {
        var player = players[i];
        var option = document.createElement('option');
        option.value = player.id;
        option.textContent = player.name || (player.firstName + ' ' + player.lastName);
        select.appendChild(option);
    }
}

function showPlayerDetail() {
    var playerId = parseInt(document.getElementById('playerSelect').value);
    var container = document.getElementById('playerDetail');

    if (!playerId) {
        container.innerHTML = '';
        return;
    }

    var player = players.find(p => p.id === playerId);
    var playerScores = scores.filter(s => s.playerId === playerId);

    if (playerScores.length === 0) {
        container.innerHTML = '<div class="card"><p>Aucun score enregistr√© pour ce joueur.</p></div>';
        return;
    }

    var playerName = player.name || (player.firstName + ' ' + player.lastName);

    // Statistiques du joueur
    var avgGross = playerScores.reduce((sum, s) => sum + s.score, 0) / playerScores.length;
    var avgNet = playerScores.reduce((sum, s) => sum + s.net, 0) / playerScores.length;
    var bestGross = Math.min(...playerScores.map(s => s.score));
    var worstGross = Math.max(...playerScores.map(s => s.score));
    var bestNet = Math.min(...playerScores.map(s => s.net));
    var worstNet = Math.max(...playerScores.map(s => s.net));

    var diabloScores = playerScores.filter(s => s.type === 'diablo');
    var gprScores = playerScores.filter(s => s.type === 'gpr');

    var html = '<div class="player-card">' +
               '<h3>üèåÔ∏è ' + playerName + ' (Handicap Index: ' + player.handicap + ')</h3>' +
               
               '<div class="player-stats">' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + playerScores.length + '</div>' +
               '<div class="stat-label">Parties Jou√©es</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + avgGross.toFixed(1) + '</div>' +
               '<div class="stat-label">Score Brut Moyen</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + avgNet.toFixed(1) + '</div>' +
               '<div class="stat-label">Score Net Moyen</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + bestGross + '</div>' +
               '<div class="stat-label">Meilleur Score Brut</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + bestNet.toFixed(1) + '</div>' +
               '<div class="stat-label">Meilleur Score Net</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + diabloScores.length + '</div>' +
               '<div class="stat-label">Parties Diablo</div>' +
               '</div>' +
               '<div class="stat-box">' +
               '<div class="stat-value">' + gprScores.length + '</div>' +
               '<div class="stat-label">Parties GPR</div>' +
               '</div>' +
               '</div>' +
               
               '<h4>üìã Historique des Scores</h4>' +
               '<div class="score-history">';

    // Trier les scores par date (plus r√©cents en premier)
    playerScores.sort((a, b) => {
        var roundA = rounds.find(r => r.id === a.roundId);
        var roundB = rounds.find(r => r.id === b.roundId);
        return new Date(roundB.date) - new Date(roundA.date);
    });

    for (var i = 0; i < playerScores.length; i++) {
        var score = playerScores[i];
        var round = rounds.find(r => r.id === score.roundId);
        
        var scoreClass = '';
        if (score.score === bestGross) scoreClass = 'best-score';
        else if (score.score === worstGross) scoreClass = 'worst-score';
        
        var badgeClass = score.type === 'diablo' ? 'badge-diablo' : 'badge-gpr';
        var badgeText = score.type === 'diablo' ? 'üèÜ Diablo' : 'üéØ GPR';
        
        var teeIcon = score.tee === 'bleu' ? 'üîµ' : '‚ö™';
        
        html += '<div class="score-row">' +
                '<div>' +
                '<strong>' + new Date(round.date).toLocaleDateString('fr-FR') + '</strong><br>' +
                '<small>' + round.course + ' ' + teeIcon + ' ' + score.tee + '</small>' +
                '</div>' +
                '<div class="tournament-badge ' + badgeClass + '">' + badgeText + '</div>' +
                '<div style="text-align: right;">' +
                '<span class="' + scoreClass + '">Brut: ' + score.score + '</span><br>' +
                '<small>Handicap: ' + score.courseHandicap.toFixed(1) + ' | Net: ' + score.net.toFixed(1) + '</small>' +
                '</div>' +
                '</div>';
    }

    html += '</div></div>';
    container.innerHTML = html;
}

// ==============================================================================
// SECTION GESTION DES TERRAINS
// ==============================================================================

function loadCoursesList() {
    var html = '';
    var courseNames = Object.keys(coursesDatabase).sort();

    var totalTees = 0;
    for (var courseName in coursesDatabase) {
        totalTees += coursesDatabase[courseName].length;
    }

    html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">' +
            '<strong>üìä R√©sum√©:</strong> ' + courseNames.length + ' terrains avec ' + totalTees + ' d√©parts au total' +
            '</div>';

    html += '<div class="course-grid">';

    for (var i = 0; i < courseNames.length; i++) {
        var courseName = courseNames[i];
        var tees = coursesDatabase[courseName];
        
        html += '<div class="course-card">' +
                '<div class="course-header">' +
                '<div class="course-name">üèåÔ∏è ' + courseName + '</div>' +
                '<button class="btn-danger" onclick="deleteCourse(' + "'" + courseName + "'" + ')">üóëÔ∏è</button>' +
                '</div>';
        
        for (var j = 0; j < tees.length; j++) {
            var tee = tees[j];
            
            var teeIcon = '';
            switch(tee.tee) {
                case 'blanc': teeIcon = '‚ö™'; break;
                case 'bleu': teeIcon = 'üîµ'; break;
                case 'vert': teeIcon = 'üü¢'; break;
                case 'jaune': teeIcon = 'üü°'; break;
                case 'noir': teeIcon = '‚ö´'; break;
                default: teeIcon = 'üèåÔ∏è'; break;
            }
            
            var difficulty = '';
            var difficultyColor = '';
            if (tee.slope < 113) {
                difficulty = 'Facile';
                difficultyColor = '#28a745';
            } else if (tee.slope < 125) {
                difficulty = 'Moyen';
                difficultyColor = '#ffc107';
            } else if (tee.slope < 135) {
                difficulty = 'Difficile';
                difficultyColor = '#fd7e14';
            } else {
                difficulty = 'Tr√®s difficile';
                difficultyColor = '#dc3545';
            }
            
            html += '<div class="tee-info" style="border-left: 4px solid ' + difficultyColor + ';">' +
                    '<div style="display: flex; align-items: center; gap: 10px;">' +
                    '<span style="font-size: 18px;">' + teeIcon + '</span>' +
                    '<div>' +
                    '<span class="tee-color tee-' + tee.tee + '" style="padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">' + 
                    tee.tee.toUpperCase() + '</span>' +
                    '<br><small style="color: ' + difficultyColor + '; font-weight: bold;">' + difficulty + '</small>' +
                    '</div>' +
                    '</div>' +
                    '<div style="text-align: right; font-family: monospace;">' +
                    '<div><strong>Rating:</strong> ' + tee.rating + '</div>' +
                    '<div><strong>Slope:</strong> ' + tee.slope + '</div>' +
                    '<div><strong>Par:</strong> ' + tee.par + '</div>' +
                    '</div>' +
                    '</div>';
        }
        
        html += '</div>';
    }

    html += '</div>';
    document.getElementById('coursesList').innerHTML = html;
}

function toggleAddCourseForm() {
    var form = document.getElementById('addCourseForm');
    if (form.style.display === 'none') {
        form.style.display = 'block';
        document.getElementById('newCourseName').value = '';
        document.getElementById('teeInputs').innerHTML = 
            '<div class="tee-form-row">' +
            '<select>' +
            '<option value="blanc">Blanc</option>' +
            '<option value="bleu">Bleu</option>' +
            '<option value="vert">Vert</option>' +
            '<option value="jaune">Jaune</option>' +
            '<option value="noir">Noir</option>' +
            '</select>' +
            '<input type="number" placeholder="Rating (ex: 69.5)" step="0.1" min="60" max="80">' +
            '<input type="number" placeholder="Slope (ex: 123)" min="85" max="155">' +
            '<input type="number" placeholder="Par (ex: 72)" min="68" max="76">' +
            '<button type="button" class="btn-danger" onclick="removeTeeInput(this)">‚ùå</button>` +
            '</div>';
    } else {
        form.style.display = 'none';
    }
}

function addTeeInput() {
    var container = document.getElementById('teeInputs');
    var newRow = document.createElement('div');
    newRow.className = 'tee-form-row';
    newRow.innerHTML = 
        '<select>' +
        '<option value="blanc">Blanc</option>' +
        '<option value="bleu">Bleu</option>' +
        '<option value="vert">Vert</option>' +
        '<option value="jaune">Jaune</option>' +
        '<option value="noir">Noir</option>' +
        '</select>' +
        '<input type="number" placeholder="Rating (ex: 69.5)" step="0.1" min="60" max="80">' +
        '<input type="number" placeholder="Slope (ex: 123)" min="85" max="155">' +
        '<input type="number" placeholder="Par (ex: 72)" min="68" max="76">' +
        '<button type="button" class="btn-danger" onclick="removeTeeInput(this)">‚ùå</button>';
    container.appendChild(newRow);
}

function removeTeeInput(button) {
    var container = document.getElementById('teeInputs');
    if (container.children.length > 1) {
        button.parentElement.remove();
    }
}

function saveCourse() {
    var courseName = document.getElementById('newCourseName').value.trim();
    if (!courseName) {
        alert('Veuillez saisir le nom du terrain.');
        return;
    }
    
    if (coursesDatabase[courseName]) {
        if (!confirm('Ce terrain existe d√©j√†. Voulez-vous le remplacer?')) {
            return;
        }
    }
    
    var teeRows = document.querySelectorAll('#teeInputs .tee-form-row');
    var tees = [];
    
    for (var i = 0; i < teeRows.length; i++) {
        var row = teeRows[i];
        var select = row.querySelector('select');
        var ratingInput = row.querySelectorAll('input')[0];
        var slopeInput = row.querySelectorAll('input')[1];
        var parInput = row.querySelectorAll('input')[2];
        
        var teeColor = select.value;
        var rating = parseFloat(ratingInput.value);
        var slope = parseInt(slopeInput.value);
        var par = parseInt(parInput.value);
        
        if (!rating || !slope || !par || rating < 60 || rating > 80 || slope < 85 || slope > 155 || par < 68 || par > 76) {
            alert('Veuillez remplir tous les champs avec des valeurs valides (Rating: 60-80, Slope: 85-155, Par: 68-76).');
            return;
        }
        
        tees.push({
            tee: teeColor,
            rating: rating,
            slope: slope,
            par: par
        });
    }
    
    coursesDatabase[courseName] = tees;
    loadCoursesList();
    toggleAddCourseForm();
    
    document.getElementById('coursesList').insertAdjacentHTML('afterbegin',
        '<div class="alert-success">‚úÖ Terrain "' + courseName + '" ajout√© avec succ√®s!</div>'
    );
    
    setTimeout(function() {
        var alert = document.querySelector('#coursesList .alert-success');
        if (alert) alert.remove();
    }, 3000);
    
    // Sauvegarder automatiquement
    autoSave();
}

function cancelAddCourse() {
    toggleAddCourseForm();
}

function deleteCourse(courseName) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer le terrain "' + courseName + '"?')) {
        delete coursesDatabase[courseName];
        loadCoursesList();
        
        document.getElementById('coursesList').insertAdjacentHTML('afterbegin',
            '<div class="alert-danger">üóëÔ∏è Terrain "' + courseName + '" supprim√©.</div>'
        );
        
        setTimeout(function() {
            var alert = document.querySelector('#coursesList .alert-danger');
            if (alert) alert.remove();
        }, 3000);
        
        // Sauvegarder automatiquement
        autoSave();
    }
}

function exportCourses() {
    var dataToExport = {
        courses: coursesDatabase,
        exportDate: new Date().toISOString(),
        totalCourses: Object.keys(coursesDatabase).length
    };
    
    var dataStr = JSON.stringify(dataToExport, null, 2);
    var dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    var link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'terrains-golf-' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
}

// ==============================================================================
// SECTION DIABLO
// ==============================================================================

function loadDiablo() {
    loadYearSelectors();

    var selectedYear = document.getElementById('diabloYearSelect').value;

    var diabloScores = scores.filter(s => {
       return s.type === 'diablo' && (!selectedYear || s.year == selectedYear);
    });

    if (diabloScores.length === 0) {
        document.getElementById('diabloContent').innerHTML = '<p>Aucune partie Diablo trouv√©e pour cette p√©riode.</p>';
        document.getElementById('diabloStatus').innerHTML = '';
        return;
    }

    updateDiabloStatus(selectedYear);

    var playerStats = {};

    for (var i = 0; i < diabloScores.length; i++) {
        var score = diabloScores[i];
        if (!playerStats[score.playerId]) {
            var player = players.find(p => p.id === score.playerId);
            var playerName = player ? (player.name || (player.firstName + ' ' + player.lastName)) : ('Joueur #' + score.playerId);
            
            playerStats[score.playerId] = {
                player: player,
                playerName: playerName,
                totalRounds: 0,
                totalNet: 0
            };
        }
        playerStats[score.playerId].totalRounds++;
        playerStats[score.playerId].totalNet += score.net;
    }

    var leaderboard = [];
    for (var playerId in playerStats) {
        var stats = playerStats[playerId];
        leaderboard.push({
            player: stats.player,
            playerName: stats.playerName,
            rounds: stats.totalRounds,
            avgNet: stats.totalNet / stats.totalRounds
        });
    }

    leaderboard.sort((a, b) => a.avgNet - b.avgNet);

    var yearText = selectedYear ? selectedYear : 'Toutes les ann√©es';
    var html = '<div class="card"><h3>Coupe Diablo - ' + yearText + ' (Septembre)</h3>' +
               '<p>Parties en septembre uniquement</p></div>' +
               '<table class="table"><thead><tr><th>Position</th><th>Joueur</th><th>Parties</th><th>Score Net Moyen</th></tr></thead><tbody>';

    for (var i = 0; i < leaderboard.length; i++) {
        var stats = leaderboard[i];
        var rowStyle = '';
        if (i === 0) rowStyle = ' style="background: gold;"';
        else if (i === 1) rowStyle = ' style="background: silver;"';
        else if (i === 2) rowStyle = ' style="background: #cd7f32;"';
        
        html += '<tr' + rowStyle + '>' +
                '<td><strong>' + (i + 1) + '</strong></td>' +
                '<td><strong>' + stats.playerName + '</strong></td>' +
                '<td>' + stats.rounds + '</td>' +
                '<td><strong>' + stats.avgNet.toFixed(1) + '</strong></td>' +
                '</tr>';
    }

    html += '</tbody></table>';
    document.getElementById('diabloContent').innerHTML = html;
}

// ==============================================================================
// SECTION GPR
// ==============================================================================

function loadGPR() {
    loadYearSelectors();

    var selectedYear = document.getElementById('gprYearSelect').value;

    var gprScores = scores.filter(s => {
        return s.type === 'gpr' && (!selectedYear || s.year == selectedYear);
    });

    if (gprScores.length === 0) {
        document.getElementById('gprContent').innerHTML = '<p>Aucune partie GPR trouv√©e pour cette p√©riode.</p>';
        document.getElementById('gprStatus').innerHTML = '';
        return;
    }

    updateGPRStatus(selectedYear);

    var gprRounds = rounds.filter(r => {
        return r.type === 'gpr' && (!selectedYear || r.year == selectedYear);
    });

    var playerPoints = {};
    var roundDetails = [];
    var pointsScale = [120, 105, 90, 78, 70, 62, 54, 46, 38, 30, 22, 15];
    var grossPointsScale = [80, 68, 60, 52, 45, 40, 35, 30, 25, 20, 15, 10];

    // Calculer les points pour chaque partie
    for (var i = 0; i < gprRounds.length; i++) {
        var round = gprRounds[i];
        var roundScores = gprScores.filter(s => s.roundId === round.id);
        
        var netRanking = [...roundScores].sort((a, b) => a.net - b.net);
        var grossRanking = [...roundScores].sort((a, b) => a.score - b.score);
        
        var roundDetail = {
            round: round,
            netRanking: [],
            grossRanking: []
        };
        
        // Calculer les points nets
        for (var j = 0; j < netRanking.length; j++) {
            var score = netRanking[j];
            var netPoints = pointsScale[Math.min(j, pointsScale.length - 1)];
            
            roundDetail.netRanking.push({
                player: score,
                position: j + 1,
                points: netPoints
            });
        }
        
        // Calculer les points bruts
        for (var j = 0; j < grossRanking.length; j++) {
            var score = grossRanking[j];
            var grossPoints = grossPointsScale[Math.min(j, grossPointsScale.length - 1)];
            
            roundDetail.grossRanking.push({
                player: score,
                position: j + 1,
                points: grossPoints
            });
        }
        
        roundDetails.push(roundDetail);
        
        // Accumuler les points pour chaque joueur
        for (var k = 0; k < roundScores.length; k++) {
            var score = roundScores[k];
            if (!playerPoints[score.playerId]) {
                var player = players.find(p => p.id === score.playerId);
                var playerName = player ? (player.name || (player.firstName + ' ' + player.lastName)) : ('Joueur #' + score.playerId);
                
                playerPoints[score.playerId] = {
                    player: player,
                    playerName: playerName,
                    totalPoints: 0,
                    rounds: 0,
                    details: []
                };
            }
            
            var netResult = roundDetail.netRanking.find(r => r.player.playerId === score.playerId);
            var grossResult = roundDetail.grossRanking.find(r => r.player.playerId === score.playerId);
            
            var netPoints = netResult ? netResult.points : 0;
            var grossPoints = grossResult ? grossResult.points : 0;
            var totalRoundPoints = netPoints + grossPoints;
            
            playerPoints[score.playerId].totalPoints += totalRoundPoints;
            playerPoints[score.playerId].rounds++;
            
            playerPoints[score.playerId].details.push({
                round: round,
                grossScore: score.score,
                netScore: score.net,
                grossPosition: grossResult.position,
                netPosition: netResult.position,
                grossPoints: grossPoints,
               netPoints: netPoints,
                totalRoundPoints: totalRoundPoints,
                courseHandicap: score.courseHandicap
            });
        }
    }

    // Cr√©er le classement g√©n√©ral
    var leaderboard = [];
    for (var playerId in playerPoints) {
        var stats = playerPoints[playerId];
        leaderboard.push({
            player: stats.player,
            playerName: stats.playerName,
            rounds: stats.rounds,
            totalPoints: stats.totalPoints,
            details: stats.details,
            averagePoints: stats.totalPoints / stats.rounds
        });
    }

    leaderboard.sort((a, b) => b.totalPoints - a.totalPoints);

    var yearText = selectedYear ? selectedYear : 'Toutes les ann√©es';

    // Affichage du classement g√©n√©ral
    var html = '<div class="card"><h3>Coupe GPR - ' + yearText + ' (Mai √† Juillet)</h3>' +
               '<p>Parties de mai √† juillet uniquement</p></div>' +
               
               '<div class="card">' +
               '<h4>üèÜ Classement G√©n√©ral GPR</h4>' +
               '<table class="table">' +
               '<thead><tr><th>Position</th><th>Joueur</th><th>Parties</th><th>Points Totaux</th><th>Moyenne/Partie</th><th>D√©tails</th></tr></thead>' +
               '<tbody>';

    for (var i = 0; i < leaderboard.length; i++) {
        var stats = leaderboard[i];
        var rowStyle = '';
        if (i === 0) rowStyle = ' style="background: gold;"';
        else if (i === 1) rowStyle = ' style="background: silver;"';
        else if (i === 2) rowStyle = ' style="background: #cd7f32;"';
        
        html += '<tr' + rowStyle + '>' +
                '<td><strong>' + (i + 1) + '</strong></td>' +
                '<td><strong>' + stats.playerName + '</strong></td>' +
                '<td>' + stats.rounds + '</td>' +
                '<td><strong>' + stats.totalPoints + '</strong></td>' +
                '<td>' + stats.averagePoints.toFixed(1) + '</td>' +
                '<td><button class="btn-secondary" onclick="showGPRPlayerDetails(' + stats.player.id + ', \'' + selectedYear + '\')">üìä Voir d√©tails</button></td>' +
                '</tr>';
    }

    html += '</tbody></table></div>';

    // Affichage des parties individuelles
    html += '<div class="card">' +
            '<h4>üìÖ D√©tails des Parties GPR</h4>' +
            '<p>Cliquez sur une partie pour voir les classements d√©taill√©s</p>';

    for (var i = 0; i < roundDetails.length; i++) {
        var roundDetail = roundDetails[i];
        var round = roundDetail.round;
        
        html += '<div style="margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background: #f9f9f9;">' +
                '<div style="display: flex; justify-content: space-between; align-items: center;">' +
                '<div>' +
                '<strong>' + new Date(round.date).toLocaleDateString('fr-FR') + ' - ' + round.course + '</strong>' +
                '<br><small>' + roundDetail.netRanking.length + ' joueurs</small>' +
                '</div>' +
                '<button class="btn" onclick="toggleRoundDetail('round_${round.id}')">üëÅÔ∏è Voir classements</button>` +
                '</div>' +
                
                '<div id="round_' + round.id + '" style="display: none; margin-top: 15px;">' +
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">' +
                
                // Classement net
                '<div>' +
                '<h5>üéØ Classement Score Net</h5>' +
                '<table class="table" style="font-size: 14px;">' +
                '<thead><tr><th>Pos</th><th>Joueur</th><th>Score Net</th><th>Points</th></tr></thead>' +
               '<tbody>';
        
        for (var j = 0; j < roundDetail.netRanking.length; j++) {
            var result = roundDetail.netRanking[j];
            var playerScore = result.player;
            
            html += '<tr>' +
                    '<td><strong>' + result.position + '</strong></td>' +
                    '<td>' + playerScore.playerName + '</td>' +
                    '<td><strong>' + playerScore.net.toFixed(1) + '</strong></td>' +
                    '<td><span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px;">' + result.points + '</span></td>' +
                    '</tr>';
        }
        
        html += '</tbody></table></div>' +
                
                // Classement brut
                '<div>' +
                '<h5>üèåÔ∏è Classement Score Brut</h5>' +
                '<table class="table" style="font-size: 14px;">' +
                '<thead><tr><th>Pos</th><th>Joueur</th><th>Score Brut</th><th>Points</th></tr></thead>' +
                '<tbody>';
        
        for (var j = 0; j < roundDetail.grossRanking.length; j++) {
            var result = roundDetail.grossRanking[j];
            var playerScore = result.player;
            
            html += '<tr>' +
                    '<td><strong>' + result.position + '</strong></td>' +
                    '<td>' + playerScore.playerName + '</td>' +
                    '<td><strong>' + playerScore.score + '</strong></td>' +
                    '<td><span style="background: #17a2b8; color: white; padding: 2px 6px; border-radius: 10px;">' + result.points + '</span></td>' +
                    '</tr>';
        }
        
        html += '</tbody></table></div>' +
                '</div></div></div>';
    }

    html += '</div>';
    document.getElementById('gprContent').innerHTML = html;
}

function toggleRoundDetail(roundId) {
    var element = document.getElementById(roundId);
    if (element.style.display === 'none') {
        element.style.display = 'block';
    } else {
        element.style.display = 'none';
    }
}

function showGPRPlayerDetails(playerId, selectedYear) {
    var gprScores = scores.filter(s => {
        return s.type === 'gpr' && s.playerId === playerId && (!selectedYear || s.year == selectedYear);
    });

    if (gprScores.length === 0) {
        alert('Aucune partie GPR trouv√©e pour ce joueur.');
        return;
    }

    var player = players.find(p => p.id === playerId);
    var playerName = player ? (player.name || (player.firstName + ' ' + player.lastName)) : 'Joueur #' + playerId;

    var pointsScale = [120, 105, 90, 78, 70, 62, 54, 46, 38, 30, 22, 15];
    var grossPointsScale = [80, 68, 60, 52, 45, 40, 35, 30, 25, 20, 15, 10];

    var html = '<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center;">' +
               '<div style="background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">' +
               '<h3 style="margin-top: 0; color: #2c5530;">üìä D√©tails GPR - ' + playerName + '</h3>' +
               
               '<table class="table">' +
               '<thead><tr><th>Date</th><th>Terrain</th><th>Score Brut</th><th>Pos. Brut</th><th>Pts Brut</th><th>Score Net</th><th>Pos. Net</th><th>Pts Net</th><th>Total Pts</th></tr></thead>' +
               '<tbody>';

    var totalPoints = 0;

    gprScores.sort((a, b) => new Date(a.roundId) - new Date(b.roundId));

    for (var i = 0; i < gprScores.length; i++) {
        var score = gprScores[i];
        var round = rounds.find(r => r.id === score.roundId);
        
        if (!round) continue;
        
        var roundScores = scores.filter(s => s.roundId === score.roundId);
        
        var grossRanking = [...roundScores].sort((a, b) => a.score - b.score);
        var grossPosition = grossRanking.findIndex(s => s.playerId === playerId) + 1;
        var grossPoints = grossPointsScale[Math.min(grossPosition - 1, grossPointsScale.length - 1)];
        
        var netRanking = [...roundScores].sort((a, b) => a.net - b.net);
        var netPosition = netRanking.findIndex(s => s.playerId === playerId) + 1;
        var netPoints = pointsScale[Math.min(netPosition - 1, pointsScale.length - 1)];
        
        var roundTotal = grossPoints + netPoints;
        totalPoints += roundTotal;
        
        html += '<tr>' +
                '<td>' + new Date(round.date).toLocaleDateString('fr-FR') + '</td>' +
                '<td><small>' + round.course + '</small></td>' +
                '<td><strong>' + score.score + '</strong></td>' +
                '<td>' + grossPosition + '</td>' +
                '<td><span style="background: #17a2b8; color: white; padding: 1px 5px; border-radius: 8px; font-size: 12px;">' + grossPoints + '</span></td>' +
                '<td><strong>' + score.net.toFixed(1) + '</strong></td>' +
                '<td>' + netPosition + '</td>' +
                '<td><span style="background: #28a745; color: white; padding: 1px 5px; border-radius: 8px; font-size: 12px;">' + netPoints + '</span></td>' +
                '<td><strong>' + roundTotal + '</strong></td>' +
                '</tr>';
    }

    html += '</tbody></table>' +
            
            '<div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: center;">' +
            '<strong>R√©sum√©:</strong> ' + gprScores.length + ' parties GPR | ' +
            '<strong>Total: ' + totalPoints + ' points</strong> | ' +
            '<strong>Moyenne: ' + (totalPoints / gprScores.length).toFixed(1) + ' pts/partie</strong>' +
            '</div>' +
            
            '<div style="margin-top: 25px; text-align: center;">' +
            `<button onclick="closeGPRPlayerDetails()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">‚ùå Fermer</button>` +
            '</div>' +
            
            '</div></div>';

    var popup = document.createElement('div');
    popup.id = 'gprPlayerDetailsPopup';
    popup.innerHTML = html;
    document.body.appendChild(popup);
}

function closeGPRPlayerDetails() {
    var popup = document.getElementById('gprPlayerDetailsPopup');
    if (popup) {
        popup.remove();
    }
}

// ==============================================================================
// FONCTIONS UTILITAIRES POUR DIABLO ET GPR
// ==============================================================================

function loadYearSelectors() {
    var years = [];
    for (var i = 0; i < rounds.length; i++) {
        if (years.indexOf(rounds[i].year) === -1) {
            years.push(rounds[i].year);
        }
    }
    years.sort();

    var diabloSelect = document.getElementById('diabloYearSelect');
    var gprSelect = document.getElementById('gprYearSelect');
    
    var currentDiabloYear = diabloSelect.value;
    var currentGprYear = gprSelect.value;
    
    diabloSelect.innerHTML = '<option value="">-- Toutes les ann√©es --</option>';
    gprSelect.innerHTML = '<option value="">-- Toutes les ann√©es --</option>';
    
    for (var i = 0; i < years.length; i++) {
        var year = years[i];
        
        var diabloOption = document.createElement('option');
        diabloOption.value = year;
        diabloOption.textContent = year;
        if (year == currentDiabloYear) diabloOption.selected = true;
        diabloSelect.appendChild(diabloOption);
        
        var gprOption = document.createElement('option');
        gprOption.value = year;
        gprOption.textContent = year;
        if (year == currentGprYear) gprOption.selected = true;
        gprSelect.appendChild(gprOption);
    }
}

function updateDiabloStatus(selectedYear) {
    var statusElement = document.getElementById('diabloStatus');
    var currentDate = new Date();
    var currentYear = currentDate.getFullYear();
    var currentMonth = currentDate.getMonth() + 1;
    
    if (!selectedYear || selectedYear == currentYear) {
        if (currentMonth >= 9) {
            statusElement.innerHTML = 'üî¥ En cours';
            statusElement.style.background = '#28a745';
            statusElement.style.color = 'white';
        } else {
            statusElement.innerHTML = '‚è≥ √Ä venir (Septembre)';
            statusElement.style.background = '#ffc107';
            statusElement.style.color = 'black';
        }
    } else if (selectedYear < currentYear) {
        statusElement.innerHTML = '‚úÖ Termin√©e';
        statusElement.style.background = '#6c757d';
        statusElement.style.color = 'white';
    } else {
        statusElement.innerHTML = 'üìÖ Future';
        statusElement.style.background = '#17a2b8';
        statusElement.style.color = 'white';
    }
}

function updateGPRStatus(selectedYear) {
    var statusElement = document.getElementById('gprStatus');
    var currentDate = new Date();
    var currentYear = currentDate.getFullYear();
    var currentMonth = currentDate.getMonth() + 1;
    
    if (!selectedYear || selectedYear == currentYear) {
        if (currentMonth >= 5 && currentMonth <= 7) {
            statusElement.innerHTML = 'üî¥ En cours';
            statusElement.style.background = '#28a745';
            statusElement.style.color = 'white';
        } else if (currentMonth < 5) {
            statusElement.innerHTML = '‚è≥ √Ä venir (Mai-Juillet)';
            statusElement.style.background = '#ffc107';
            statusElement.style.color = 'black';
        } else {
            statusElement.innerHTML = '‚úÖ Termin√©e';
            statusElement.style.background = '#6c757d';
            statusElement.style.color = 'white';
        }
    } else if (selectedYear < currentYear) {
        statusElement.innerHTML = '‚úÖ Termin√©e';
        statusElement.style.background = '#6c757d';
        statusElement.style.color = 'white';
    } else {
        statusElement.innerHTML = 'üìÖ Future';
        statusElement.style.background = '#17a2b8';
        statusElement.style.color = 'white';
    }
}

function getGPRLeader(gprRounds, gprScores) {
    var playerPoints = {};
    var pointsScale = [120, 105, 90, 78, 70, 62, 54, 46, 38, 30, 22, 15];
    var grossPointsScale = [80, 68, 60, 52, 45, 40, 35, 30, 25, 20, 15, 10];

    for (var i = 0; i < gprRounds.length; i++) {
        var round = gprRounds[i];
        var roundScores = gprScores.filter(s => s.roundId === round.id);
        
        roundScores.sort((a, b) => a.net - b.net);
        
        for (var k = 0; k < roundScores.length; k++) {
            var score = roundScores[k];
            if (!playerPoints[score.playerId]) {
                var player = players.find(p => p.id === score.playerId);
                var playerName = player ? (player.name || (player.firstName + ' ' + player.lastName)) : ('Joueur #' + score.playerId);
                
                playerPoints[score.playerId] = {
                    playerName: playerName,
                    totalPoints: 0
                };
            }
            
            var netPoints = pointsScale[Math.min(k, pointsScale.length - 1)];
            var grossPoints = grossPointsScale[Math.min(k, grossPointsScale.length - 1)];
            
            playerPoints[score.playerId].totalPoints += netPoints + grossPoints;
        }
    }

    var maxPoints = 0;
    var leader = 'Aucun';
    for (var playerId in playerPoints) {
        if (playerPoints[playerId].totalPoints > maxPoints) {
            maxPoints = playerPoints[playerId].totalPoints;
            leader = playerPoints[playerId].playerName + ' (' + maxPoints + ' pts)';
        }
    }

    return leader;
}

function getDiabloLeader(diabloScores) {
    var playerStats = {};

    for (var i = 0; i < diabloScores.length; i++) {
        var score = diabloScores[i];
        if (!playerStats[score.playerId]) {
            var player = players.find(p => p.id === score.playerId);
            var playerName = player ? (player.name || (player.firstName + ' ' + player.lastName)) : ('Joueur #' + score.playerId);
            
            playerStats[score.playerId] = {
                playerName: playerName,
                totalNet: 0,
                rounds: 0
            };
        }
        playerStats[score.playerId].totalNet += score.net;
        playerStats[score.playerId].rounds++;
    }

    var bestAvg = 999;
    var leader = 'Aucun';
    for (var playerId in playerStats) {
        var avg = playerStats[playerId].totalNet / playerStats[playerId].rounds;
        if (avg < bestAvg) {
            bestAvg = avg;
            leader = playerStats[playerId].playerName + ' (' + avg.toFixed(1) + ' net)';
        }
    }

    return leader;
}

// ==============================================================================
// SECTION PROGRESSION
// ==============================================================================

function loadProgress() {
    var currentDate = new Date();
    var currentYear = currentDate.getFullYear();
    var currentMonth = currentDate.getMonth() + 1;
    
    var html = '<div class="card">' +
               '<h3>√âtat des Coupes ' + currentYear + '</h3>' +
               '</div>';
    
    // Progression GPR
    var gprRounds = rounds.filter(r => r.type === 'gpr' && r.year === currentYear);
    var gprScores = scores.filter(s => s.type === 'gpr' && s.year === currentYear);
    
    html += '<div class="card">' +
            '<h4>üéØ Coupe GPR ' + currentYear + ' (Mai - Juillet)</h4>';
    
    if (currentMonth >= 5 && currentMonth <= 7) {
        html += '<p style="color: #28a745;"><strong>üî¥ EN COURS</strong></p>';
    } else if (currentMonth < 5) {
        html += '<p style="color: #ffc107;"><strong>‚è≥ √Ä VENIR</strong></p>';
    } else {
        html += '<p style="color: #6c757d;"><strong>‚úÖ TERMIN√âE</strong></p>';
    }
    
    html += '<p><strong>Parties jou√©es:</strong> ' + gprRounds.length + '</p>' +
            '<p><strong>Participants:</strong> ' + getUniquePlayersCount(gprScores) + '</p>';
    
    if (gprScores.length > 0) {
        var gprLeader = getGPRLeader(gprRounds, gprScores);
        html += '<p><strong>Leader actuel:</strong> ' + gprLeader + '</p>';
    }
    
    html += '</div>';
    
    // Progression Diablo
    var diabloRounds = rounds.filter(r => r.type === 'diablo' && r.year === currentYear);
    var diabloScores = scores.filter(s => s.type === 'diablo' && s.year === currentYear);
    
    html += '<div class="card">' +
            '<h4>üèÜ Coupe Diablo ' + currentYear + ' (Septembre)</h4>';
    
    if (currentMonth >= 9) {
        html += '<p style="color: #28a745;"><strong>üî¥ EN COURS</strong></p>';
    } else {
        html += '<p style="color: #ffc107;"><strong>‚è≥ √Ä VENIR</strong></p>';
    }
    
    html += '<p><strong>Parties jou√©es:</strong> ' + diabloRounds.length + '</p>' +
            '<p><strong>Participants:</strong> ' + getUniquePlayersCount(diabloScores) + '</p>';
    
    if (diabloScores.length > 0) {
        var diabloLeader = getDiabloLeader(diabloScores);
        html += '<p><strong>Leader actuel:</strong> ' + diabloLeader + '</p>';
    }
    
    html += '</div>';
    
    document.getElementById('progressContent').innerHTML = html;
}

// ==============================================================================
// SECTION D√âTAILS PAR PARTIE
// ==============================================================================

function loadDetails() {
    var select = document.getElementById('roundSelect');
    select.innerHTML = '<option value="">-- S√©lectionner une partie --</option>';
    
    for (var i = 0; i < rounds.length; i++) {
        var round = rounds[i];
        var icon = round.type === 'diablo' ? 'üèÜ' : 'üéØ';
        var date = new Date(round.date).toLocaleDateString('fr-FR');
        
        var option = document.createElement('option');
        option.value = round.id;
        option.textContent = icon + ' ' + date + ' - ' + round.course;
        select.appendChild(option);
    }
}

function showRoundDetail() {
    var roundId = parseInt(document.getElementById('roundSelect').value);
    if (!roundId) {
        document.getElementById('detailsContent').innerHTML = '';
        return;
    }

    var round = rounds.find(r => r.id === roundId);
    var roundScores = scores.filter(s => s.roundId === roundId);

    if (!round || roundScores.length === 0) {
        document.getElementById('detailsContent').innerHTML = '<p>Aucun score pour cette partie.</p>';
        return;
    }

    roundScores.sort((a, b) => a.net - b.net);

    var html = '<div class="card">' +
               '<h3>' + new Date(round.date).toLocaleDateString('fr-FR') + ' - ' + round.course + '</h3>' +
               '<p><strong>Type:</strong> ' + (round.type === 'diablo' ? 'Coupe Diablo' : 'Coupe GPR') + '</p>' +
               '<p><strong>D√©part:</strong> ' + (round.tee === 'bleu' ? 'üîµ Bleu' : '‚ö™ Blanc') + ' (Antonio: ' + (teeUsed[round.id-1] === 'bleu' ? 'üîµ Bleu' : '‚ö™ Blanc') + ', Autres: ‚ö™ Blanc)</p>' +
               '</div>' +
               '<table class="table">' +
               '<thead><tr><th>Position</th><th>Joueur</th><th>D√©part</th><th>Score Brut</th><th>Handicap Parcours</th><th>Score Net</th></tr></thead>' +
               '<tbody>';

    for (var i = 0; i < roundScores.length; i++) {
        var score = roundScores[i];
        var rowStyle = '';
        if (i === 0) rowStyle = ' style="background: gold;"';
        else if (i === 1) rowStyle = ' style="background: silver;"';
        else if (i === 2) rowStyle = ' style="background: #cd7f32;"';
        
        var teeIcon = score.tee === 'bleu' ? 'üîµ' : '‚ö™';
        
        html += '<tr' + rowStyle + '>' +
                '<td><strong>' + (i + 1) + '</strong></td>' +
                '<td><strong>' + score.playerName + '</strong></td>' +
                '<td>' + teeIcon + ' ' + score.tee + '</td>' +
                '<td>' + score.score + '</td>' +
                '<td>' + score.courseHandicap.toFixed(1) + '</td>' +
                '<td><strong>' + score.net.toFixed(1) + '</strong></td>' +
                '</tr>';
    }

    html += '</tbody></table>';
    document.getElementById('detailsContent').innerHTML = html;
}

// ==============================================================================
// SECTION √âVOLUTION DES HANDICAPS
// ==============================================================================

function loadHandicapEvolution() {
    prepareHandicapEvolutionData();
    createPlayerCheckboxes();
    selectDefaultPlayers();
    updateHandicapChart();
    displayHandicapStats();
}

function prepareHandicapEvolutionData() {
    console.log("üîÑ Pr√©paration des donn√©es d'√©volution avec calculs r√©els...");

    handicapEvolutionData = {};
    handicapCache = {};

    for (var i = 0; i < players.length; i++) {
        var player = players[i];
        var evolution = [];
        var playerName = player.name || (player.firstName + ' ' + player.lastName);

        console.log("Calcul pour:", playerName);

        var currentHandicap = player.handicap;

        evolution.push({
            date: dates[0] || '2023-01-01',
            handicap: currentHandicap,
            gameNumber: 0,
            change: 0
        });

        var scoresCount = 0;
        var allDifferentials = [];

        for (var j = 0; j < dates.length; j++) {
            if (allScores[i][j] !== null) {
                scoresCount++;
                var grossScore = allScores[i][j];
                var courseName = courses[j];
                var teeForPlayer = (player.id === 1) ? teeUsed[j] : 'blanc';

                var differential = calculateScoreDifferentialReal(grossScore, courseName, teeForPlayer);
                if (differential !== null) {
                    allDifferentials.push(differential);
                }

                var newHandicap = calculateNewHandicapFromDifferentials(allDifferentials, player.handicap);
                var change = newHandicap - currentHandicap;

                evolution.push({
                    date: dates[j],
                    handicap: newHandicap,
                    gameNumber: j + 1,
                    change: change,
                    score: grossScore,
                    course: courseName,
                    differential: differential,
                    totalDifferentials: allDifferentials.length
                });

                currentHandicap = newHandicap;

                console.log(`  Partie ${j+1}: Score ${grossScore} ‚Üí Handicap ${newHandicap.toFixed(1)} (${change > 0 ? '+' : ''}${change.toFixed(1)})`);
            }
        }

        handicapEvolutionData[player.id] = {
            player: player,
            playerName: playerName,
            evolution: evolution
        };

        var finalChange = evolution.length > 1 ? evolution[evolution.length-1].handicap - evolution[0].handicap : 0;
        console.log(`${playerName} - Changement total: ${finalChange > 0 ? '+' : ''}${finalChange.toFixed(1)}`);
    }

    console.log("‚úÖ Donn√©es d'√©volution pr√©par√©es avec calculs r√©els!");
}

function createPlayerCheckboxes() {
    var container = document.getElementById('playerCheckboxes');
    var html = '';

    for (var i = 0; i < players.length; i++) {
        var player = players[i];
        var totalScores = allScores[i].filter(score => score !== null).length;
        
        if (totalScores >= 5) {
            var playerName = player.name || (player.firstName + ' ' + player.lastName);
            
            html += '<label style="display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">' +
                    '<input type="checkbox" value="' + player.id + '" onchange="togglePlayer(' + player.id + ')">' +
                    '<span><strong>' + playerName + '</strong> (' + totalScores + ' parties)</span>' +
                    '</label>';
        }
    }

    container.innerHTML = html;
}

function selectDefaultPlayers() {
    var checkboxes = document.querySelectorAll('#playerCheckboxes input[type="checkbox"]');
    selectedPlayers = [];

    for (var i = 0; i < Math.min(3, checkboxes.length); i++) {
        checkboxes[i].checked = true;
        selectedPlayers.push(parseInt(checkboxes[i].value));
    }
}

function togglePlayer(playerId) {
    var index = selectedPlayers.indexOf(playerId);
    if (index > -1) {
        selectedPlayers.splice(index, 1);
    } else {
        selectedPlayers.push(playerId);
    }
}

function selectAllPlayers() {
    var checkboxes = document.querySelectorAll('#playerCheckboxes input[type="checkbox"]');
    selectedPlayers = [];

    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = true;
        selectedPlayers.push(parseInt(checkboxes[i].value));
    }

    updateHandicapChart();
}

function clearAllPlayers() {
    var checkboxes = document.querySelectorAll('#playerCheckboxes input[type="checkbox"]');
    selectedPlayers = [];

    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
    }

    updateHandicapChart();
    displayHandicapStats();
}

function updateHandicapChart() {
    if (selectedPlayers.length === 0) {
        document.getElementById('handicapChart').innerHTML = 
            '<div style="text-align: center; padding: 50px; color: #666; border: 2px dashed #ddd; border-radius: 8px; background: #f9f9fa;">' +
            '<h3 style="color: #999; margin-bottom: 10px;">üìà Graphique d\'√âvolution</h3>' +
            '<p>Veuillez s√©lectionner au moins un joueur pour voir le graphique d\'√©volution des handicaps.</p>' +
            '<p style="font-size: 14px; color: #999;">Les statistiques de tous les joueurs sont affich√©es ci-dessous.</p>' +
            '</div>';
        
        displayHandicapStats();
        return;
    }

    document.getElementById('handicapChart').innerHTML = 
        '<canvas id="handicapCanvas" width="1000" height="500" style="max-width: 100%; border: 1px solid #ddd; border-radius: 8px;"></canvas>';

    drawHandicapChart();
    displayHandicapStats();
}

function drawHandicapChart() {
    var canvas = document.getElementById('handicapCanvas');
    var ctx = canvas.getContext('2d');

    var width = canvas.width;
    var height = canvas.height;
    var padding = 60;
    var chartWidth = width - 2 * padding;
    var chartHeight = height - 2 * padding;

    ctx.clearRect(0, 0, width, height);

    var colors = ['#e74c3c', '#3498db', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e', '#f1c40f', '#95a5a6', '#d35400', '#8e44ad', '#16a085'];

    var minHandicap = Infinity;
    var maxHandicap = -Infinity;
    var maxGames = 0;

    for (var i = 0; i < selectedPlayers.length; i++) {
        var playerId = selectedPlayers[i];
        var evolution = handicapEvolutionData[playerId].evolution;
        
        for (var j = 0; j < evolution.length; j++) {
            minHandicap = Math.min(minHandicap, evolution[j].handicap);
            maxHandicap = Math.max(maxHandicap, evolution[j].handicap);
            maxGames = Math.max(maxGames, evolution[j].gameNumber);
        }
    }

    var handicapRange = maxHandicap - minHandicap;
    minHandicap -= handicapRange * 0.1;
    maxHandicap += handicapRange * 0.1;

    // Dessiner les axes
    ctx.strokeStyle = '#333';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(padding, padding);
    ctx.lineTo(padding, height - padding);
    ctx.lineTo(width - padding, height - padding);
    ctx.stroke();

    // Grille horizontale
    ctx.strokeStyle = '#e0e0e0';
    ctx.lineWidth = 1;
    for (var i = 0; i <= 10; i++) {
        var y = padding + (chartHeight * i / 10);
        ctx.beginPath();
        ctx.moveTo(padding, y);
        ctx.lineTo(width - padding, y);
        ctx.stroke();
        
        var handicapValue = maxHandicap - (handicapRange * i / 10);
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'right';
        ctx.fillText(handicapValue.toFixed(1), padding - 10, y + 4);
    }

    // Grille verticale
    for (var i = 0; i <= maxGames; i += Math.max(1, Math.floor(maxGames / 10))) {
        var x = padding + (chartWidth * i / maxGames);
        ctx.beginPath();
        ctx.moveTo(x, padding);
        ctx.lineTo(x, height - padding);
        ctx.stroke();
        
        ctx.fillStyle = '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('P' + i, x, height - padding + 20);
    }

    // Dessiner les lignes des joueurs
    for (var i = 0; i < selectedPlayers.length; i++) {
        var playerId = selectedPlayers[i];
        var playerData = handicapEvolutionData[playerId];
        var evolution = playerData.evolution;
        var color = colors[i % colors.length];
        
        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = 3;
        
        ctx.beginPath();
        for (var j = 0; j < evolution.length; j++) {
            var point = evolution[j];
            var x = padding + (chartWidth * point.gameNumber / maxGames);
            var y = padding + (chartHeight * (maxHandicap - point.handicap) / handicapRange);
            
            if (j === 0) {
                ctx.moveTo(x, y);
            } else {
                ctx.lineTo(x, y);
            }
        }
        ctx.stroke();
        
        // Points
        for (var j = 0; j < evolution.length; j++) {
            var point = evolution[j];
            var x = padding + (chartWidth * point.gameNumber / maxGames);
            var y = padding + (chartHeight * (maxHandicap - point.handicap) / handicapRange);
            
            ctx.beginPath();
            ctx.arc(x, y, 4, 0, 2 * Math.PI);
            ctx.fill();
        }
    }

    // L√©gende
    var legendY = 20;
    for (var i = 0; i < selectedPlayers.length; i++) {
        var playerId = selectedPlayers[i];
        var playerData = handicapEvolutionData[playerId];
        var color = colors[i % colors.length];
        
        var playerName = playerData.playerName || playerData.player.name || (playerData.player.firstName + ' ' + playerData.player.lastName);
        
        ctx.fillStyle = color;
        ctx.fillRect(width - 200, legendY + (i * 25), 15, 15);
        
        ctx.fillStyle = '#333';
        ctx.font = '14px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(playerName, width - 180, legendY + (i * 25) + 12);
    }

    // Titre
    ctx.fillStyle = '#333';
    ctx.font = 'bold 16px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('√âvolution des Handicaps par Partie', width / 2, 30);

    // √âtiquettes des axes
    ctx.fillStyle = '#666';
    ctx.font = '14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('Num√©ro de Partie', width / 2, height - 10);

    ctx.save();
    ctx.translate(20, height / 2);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Handicap Index', 0, 0);
    ctx.restore();
}

function displayHandicapStats() {
    var allPlayersWithScores = [];

    for (var playerId in handicapEvolutionData) {
        var playerData = handicapEvolutionData[playerId];
        var evolution = playerData.evolution;
        
        if (evolution.length >= 2) {
            allPlayersWithScores.push({
                playerId: playerId,
                playerData: playerData
            });
        }
    }

    if (allPlayersWithScores.length === 0) {
        document.getElementById('handicapStats').innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Aucune donn√©e d\'√©volution disponible</p>';
        return;
    }

    var html = '<h3>üìä Statistiques d\'√âvolution - Tous les Joueurs</h3>';
    html += '<p style="color: #666; margin-bottom: 15px;">√âvolution des handicaps pour tous les joueurs ayant au moins 5 parties</p>';
    html += '<table class="table"><thead><tr><th>Joueur</th><th>Handicap Initial</th><th>Handicap Final</th><th>Changement Total</th><th>Plus Grande Am√©lioration</th><th>Plus Grande D√©gradation</th><th>Parties</th></tr></thead><tbody>';

    allPlayersWithScores.sort((a, b) => {
        var evolutionA = a.playerData.evolution;
        var evolutionB = b.playerData.evolution;
        var changeA = evolutionA[evolutionA.length - 1].handicap - evolutionA[0].handicap;
        var changeB = evolutionB[evolutionB.length - 1].handicap - evolutionB[0].handicap;
        return changeA - changeB;
    });

    for (var i = 0; i < allPlayersWithScores.length; i++) {
        var playerData = allPlayersWithScores[i].playerData;
        var evolution = playerData.evolution;
        
        var initialHandicap = evolution[0].handicap;
        var finalHandicap = evolution[evolution.length - 1].handicap;
        var totalChange = finalHandicap - initialHandicap;
        
        var bestChange = 0;
        var worstChange = 0;
        
        for (var j = 1; j < evolution.length; j++) {
            var change = evolution[j].change;
            if (change < bestChange) bestChange = change;
            if (change > worstChange) worstChange = change;
        }
        
        var changeClass = '';
        var rowStyle = '';
        if (totalChange < -2) {
            changeClass = 'style="color: #28a745; font-weight: bold;"';
            rowStyle = ' style="background: #f8fff8;"';
        } else if (totalChange < 0) {
            changeClass = 'style="color: #28a745;"';
        } else if (totalChange > 2) {
            changeClass = 'style="color: #dc3545; font-weight: bold;"';
            rowStyle = ' style="background: #fff8f8;"';
        } else if (totalChange > 0) {
            changeClass = 'style="color: #dc3545;"';
        }
        
        var playerName = playerData.playerName || playerData.player.name || (playerData.player.firstName + ' ' + playerData.player.lastName);
        var totalGames = evolution.length - 1;
        
        html += '<tr' + rowStyle + '>' +
                '<td><strong>' + playerName + '</strong></td>' +
                '<td>' + initialHandicap.toFixed(1) + '</td>' +
                '<td>' + finalHandicap.toFixed(1) + '</td>' +
                '<td ' + changeClass + '><strong>' + (totalChange > 0 ? '+' : '') + totalChange.toFixed(1) + '</strong></td>' +
                '<td style="color: #28a745;">' + bestChange.toFixed(1) + '</td>' +
                '<td style="color: #dc3545;">+' + worstChange.toFixed(1) + '</td>' +
                '<td>' + totalGames + '</td>' +
                '</tr>';
    }

    html += '</tbody></table>';

    html += '<div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">' +
            '<strong>L√©gende:</strong> ' +
            '<span style="color: #28a745;">üü¢ Am√©lioration du handicap</span> | ' +
            '<span style="color: #dc3545;">üî¥ D√©gradation du handicap</span> | ' +
            '<span style="color: #666;">‚ö™ Changement minimal (¬±2 points)</span>' +
            '</div>';

    document.getElementById('handicapStats').innerHTML = html;
}

function exportHandicapData() {
    if (selectedPlayers.length === 0) {
        alert('Veuillez s√©lectionner au moins un joueur');
        return;
    }

    var csvContent = 'Joueur,Date,Num√©ro Partie,Handicap,Changement,Score,Terrain\n';

    for (var i = 0; i < selectedPlayers.length; i++) {
        var playerId = selectedPlayers[i];
        var playerData = handicapEvolutionData[playerId];
        var evolution = playerData.evolution;
        
        var playerName = playerData.playerName || playerData.player.name || (playerData.player.firstName + ' ' + playerData.player.lastName);
        
        for (var j = 0; j < evolution.length; j++) {
            var point = evolution[j];
            csvContent += playerName + ',' +
                         point.date + ',' +
                         point.gameNumber + ',' +
                         point.handicap.toFixed(1) + ',' +
                         point.change.toFixed(1) + ',' +
                         (point.score || '') + ',' +
                         (point.course || '') + '\n';
        }
    }

    var blob = new Blob([csvContent], { type: 'text/csv' });
    var link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'evolution-handicaps-' + new Date().toISOString().split('T')[0] + '.csv';
    link.click();
}

// ==============================================================================
// INITIALISATION AU CHARGEMENT DE LA PAGE
// ==============================================================================

// Initialisation au chargement
window.onload = function() {
    console.log('üöÄ Initialisation de l\'application Golf...');
    
    // Charger depuis Firebase d'abord, puis initialiser si pas de donn√©es
    loadFromFirebase().then(function(hasData) {
        if (!hasData) {
            // Pas de donn√©es Firebase, utiliser les donn√©es par d√©faut
            fixAllPlayerNames();
            initializeData();
            loadOverview();
        }
        console.log('‚úÖ Application Golf initialis√©e avec succ√®s!');
    }).catch(function(error) {
        console.error('‚ùå Erreur lors de l\'initialisation:', error);
        // En cas d'erreur Firebase, utiliser les donn√©es par d√©faut
        fixAllPlayerNames();
        initializeData();
        loadOverview();
    });
};

